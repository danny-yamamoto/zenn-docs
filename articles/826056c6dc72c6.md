---
title: "Start testing Web API with Playwright: Part. 1"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["playwright", "nestjs", "typescript"]
published: true
---

Playwright ã«ã¤ã„ã¦ã€‚

https://playwright.dev/

é–‹ç™ºä¸­ Product ã§ã¯ã€ End-to-End Testing ( E2E ) [^6] ã§ Playwright ã‚’ä½¿ç”¨ã™ã‚‹äºˆå®šã€‚

Product ã¯ã€æœªé–‹ã®åœ°ã‚’é€²ã‚€ãŸã‚ã€æŸ”è»Ÿã«å¤‰æ›´ã§ãã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

å¤‰æ›´ã®åº¦ã« E2E ã® Manual testing ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã¦ã¯ã€å“è³ªã‚’ä¿ã¤ã“ã¨ã¯é›£ã—ã„ã€‚

ã ã‹ã‚‰ã€ãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ– ( E2E ) ãŒå¿…è¦ã€‚ E2E ã¯åˆæœŸã‹ã‚‰æƒ³å®šã—ã¦ã„ãªã‘ã‚Œã°ã€å¾Œã‹ã‚‰è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ã¯é›£ã—ã„ã€‚

ãã—ã¦ã€ E2E ã¨ã¯åˆ¥ã« Web API Testing ã‚‚å¿…è¦ã¨ãªã‚‹ã€‚ ç”»é¢ã®æç”»ã«ä¾å­˜ã—ãªã„ API å˜ä½“ã®å‹•ä½œã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã€‚

```mermaid
graph TD;
    subgraph e2e["E2E"]
        B{Browser} -->|Request| C[Backend API]
        C -->|Response| B

        subgraph web_api_testing["Web API Testing"]
            C -->|Query| D[Database]
        end
    end

    style web_api_testing fill:#f9f,stroke:#333,stroke-width:4px;
```

Web API Testing ã« Playwright ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å…¨ä½“ã®æŠ€è¡“ Stack ã‚’çµ±ä¸€ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ€ã†ã€‚

ä»Šå›ã€Playwright ã§ Web API Test ã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹ã€‚

## å‰æ

- æ§‹æˆã¯ Monorepo ã€‚TypeScript ã§å®Ÿè£…ã—ãŸ Frontend ã¨ Backend ã‚’ 1 ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã€‚
- Monorepo ã¯ `npm workspaces` [^7] ã§ç®¡ç†ã€‚ `nx` [^1] ã‚„ `Turborepo` [^2] ã‚’ä½¿ç”¨ã—ãªã„ã®ã¯ã€ `Amplify Gen 2` [^3] ã¨ã®ç›¸æ€§ã®å•é¡Œã€‚
- ç’°å¢ƒã¯ `VS Code` ã¨ `Dev Containers` ã€‚
- Backend API ã¯ `NestJS` [^4] ã€‚

## Installation

- `Dev Containers` ã§ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ option ã®æŒ‡å®šãŒå¿…è¦ã€‚ `--ui-host=0.0.0.0`

```bash
# Create a workspace
npm init -w ./web-api-tests
cd web-api-tests
# Initialize Playwright
npm init playwright@latest
# Run tests
npx playwright test --ui-host=0.0.0.0
```

## Here we go!!

### Create a test code

- ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹ã€‚

```TypeScript
import test, { expect } from "@playwright/test";

test('api', async ({request}) => {
    const result = await request.get('http://localhost:3000')
    expect(result.status()).toBe(200);
    expect(result.ok()).toBeTruthy()
    expect(await result.text()).toEqual('Hello World!')
})
```

- NestJS ã®ãƒãƒ­ãƒ¯ã‚’ GUI ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚

![ui](/images/826056c6dc72c6-a.png)

```bash
npx playwright test --ui-host=0.0.0.0
```

- Command line ã§ã‚‚ãƒ†ã‚¹ãƒˆå¯èƒ½ã€‚

```bash
root âœ /workspaces/hogehoge/web-api-tests (main) $ npx playwright test

Running 9 tests using 6 workers
  9 passed (2.7s)

To open last HTML report run:

  npx playwright show-report

root âœ /workspaces/hogehoge/web-api-tests (main) $ 
```

- ä½•ã‚‚è¨­å®šã‚’ã›ãšã«ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ GUI ã‚’èµ·å‹•ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚å›é¿æ–¹æ³•ãŒå­˜åœ¨ã™ã‚‹ã€‚ [^5]
    - ä»Šå›ã¯ `Xquartz` ã¯ä½¿ç”¨ã—ãªã„ã€‚CI ã‚’è€ƒãˆã¦ã„ã‚‹ãŸã‚ã€Host machine ã«ä¾å­˜ã—ãŸè¨­å®šã¯é¿ã‘ã‚‹ã€‚

```bash
Running 2 tests using 1 worker
  1) [chromium] â€º example.spec.ts:3:5 â€º has title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Error: browserType.connect: Target page, context or browser has been closed
    Browser logs:

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ Looks like you launched a headed browser without having a XServer running.                     â•‘
    â•‘ Set either 'headless: true' or use 'xvfb-run <your-playwright-app>' before running Playwright. â•‘
    â•‘                                                                                                â•‘
    â•‘ <3 Playwright Team                                                                             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  2) [chromium] â€º example.spec.ts:10:5 â€º get started link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Error: browserType.connect: Target page, context or browser has been closed
    Browser logs:

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ Looks like you launched a headed browser without having a XServer running.                     â•‘
    â•‘ Set either 'headless: true' or use 'xvfb-run <your-playwright-app>' before running Playwright. â•‘
    â•‘                                                                                                â•‘
    â•‘ <3 Playwright Team                                                                             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  2 failed
    [chromium] â€º example.spec.ts:3:5 â€º has title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    [chromium] â€º example.spec.ts:10:5 â€º get started link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Practice

### Test use options
- å…±é€šã®è¨­å®šãªã©ã‚’ã©ã†ã™ã‚‹ã‹ã€‚ä¾‹ãˆã°ã€ URL ãªã©ã®ç’°å¢ƒåˆ¥ã®è¨­å®šã€‚
    - `use: {}` object ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```typescript: web-api-tests/playwright.config.ts
export default defineConfig({
    /**
     * çœç•¥
    */
    use: {
        baseURL: 'http://localhost:3000/',  // here
    },
    /**
     * çœç•¥
    */
});
```

```typescript: web-api-tests/tests/api.spec.ts
test('hoge', async ({ request, baseURL }) => {  // here
    /**
     * çœç•¥
    */
});
```

ä»Šå›ã¯ã“ã“ã¾ã§ã€‚

## Conclusion
> å¤‰ã‚ã‚Šã‚†ãæ•…ã®å®‰å®šãŒã‚ã‚‹
> ç”Ÿãã¦ã‚‹é–“ã«ç”Ÿã¾ã‚Œå¤‰ã‚ã‚Œ
> è¿·ã‚ãªã„ã“ã¨ãŒæã‚Œãªã„ã“ã¨ãŒé–“é•ã‚ãªã„ã“ã¨ãŒå¼·ã•ã§ã¯ãªã„

ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è½ã¨ã•ãšã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç¹°ã‚Šè¿”ã—æˆåŠŸã‚’æ´ã¿å–ã‚‹

ã€Œå¤‰ã‚ã‚Šç¶šã‘ã‚‹ã€ã¨è¨€ã†å®‰å®šã—ãŸçŠ¶æ…‹ã‚’ç›®æŒ‡ã™

[^1]: https://nx.dev/
[^2]: https://turbo.build/repo
[^3]: https://docs.amplify.aws/
[^4]: https://nestjs.com/
[^5]: https://future-architect.github.io/articles/20230823a/
[^6]: https://circleci.com/ja/blog/what-is-end-to-end-testing/
[^7]: https://docs.npmjs.com/cli/v7/using-npm/workspaces
