---
title: "Rust + Cloud Run + Litestream"
emoji: "ğŸ›¢ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Litestream", "rust", "googlecloud", "gc24"]
published: true
---
Litestream ã«ã¤ã„ã¦ã€‚

https://litestream.io/

> Stop building slow, complex, fragile software systems. Safely run your application on a single server.
Fully-replicated database with no pain and little cost.
> 
> é…ãã¦è¤‡é›‘ã§å£Šã‚Œã‚„ã™ã„ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã¯ã‚‚ã†ã‚„ã‚ã¾ã—ã‚‡ã†ã€‚å˜ä¸€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã«å®Ÿè¡Œã§ãã¾ã™ã€‚
å®Œå…¨ã«è¤‡è£½ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã€æ‰‹é–“ã‚‚ã‚³ã‚¹ãƒˆã‚‚ã‹ã‘ãšã«åˆ©ç”¨ã§ãã¾ã™ã€‚

[![Star History Chart](https://api.star-history.com/svg?repos=benbjohnson/litestream&type=Date)](https://star-history.com/#benbjohnson/litestream&Date)

Litestream[^1] ã¯ SQLite ã‚’è¤‡è£½ã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã‚‰ã—ã„ã€‚ä¸€ç•ªè¿‘ãã«ä¿æŒå‡ºæ¥ã¦æ°¸ç¶šåŒ–ã‚‚å‡ºæ¥ã‚‹ã€‚

Rust ã® API ã« Litestream ã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã£ã¦ã¿ã‚‹ã€‚

æ§‹æˆã¯æ¬¡ã®ã¨ãŠã‚Šã€‚

```mermaid
flowchart TD
    client
    subgraph gcs[Cloud Storage]
        generations
    end
    db1[(SQLite)]
    stream[Litestream]
    subgraph api[API]
        handler-- INSERT -->db1
        stream-->db1
    end
    client-- POST -->handler
    stream-- replicate -->generations
```

## Create Container
- Cloud Run ã®å ´åˆã€PORT `8080` ã¨ HOST `0.0.0.0` ã«æ°—ã‚’ä»˜ã‘ã‚‹ã€‚æ¯å›ãã“ã§ error ã«ãªã‚‹ã€‚
- Rocket ã¯ `Rocket.toml` ã«è¨­å®šã‚’å®šç¾©ã™ã‚‹ã€‚

https://github.com/danny-yamamoto/rust-api-samples-rocket/blob/3217ce35658f4e0472ef51dcc74d33b90fdb4907/rocket/Rocket.toml#L5-L7

- Litestream ã® binary ã‚’è¿½åŠ ã€‚

https://github.com/danny-yamamoto/rust-api-samples-rocket/blob/3217ce35658f4e0472ef51dcc74d33b90fdb4907/rocket/Dockerfile#L43-L44

- `litestream replicate` ã® background ã§ API ã‚’èµ·å‹•ã€‚

https://github.com/danny-yamamoto/rust-api-samples-rocket/blob/3217ce35658f4e0472ef51dcc74d33b90fdb4907/rocket/run.sh#L7

## Deploy
- Cloud Run ã« deployã€‚

## Check the replicate
- Create method ã‚’è¿½åŠ ã™ã‚‹ã€‚Rocket ã® post[^2] ã¯ `format` `data` ã§ Body ã‚’è¨­å®šã™ã‚‹ã€‚
```rust
#[post("/users", format = "json", data = "<user_data>")]
pub async fn user_post_handler(user_data: Json<User>, user_service: &State<Arc<UserService>>) -> (Status, (ContentType, Json<Option<User>>)) {
    let user = user_data.into_inner();
    println!("user_id: {}", user.user_id);
    match user_service.create_user(user).await {
        Ok(_) => (Status::Ok, (ContentType::JSON, Json(None))),
        Err(_) => (Status::InternalServerError, (ContentType::JSON, Json(None))),
    }
}
```

- API ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```bash
root âœ /workspaces/rust-api-samples-rocket/rocket (main) $ curl -X POST -i -H "Content-Type: application/json" -d '{"user_id" : 5}' https://rocket-kk7z4sbvqa-an.a.run.app/userssers
HTTP/2 200 
content-type: application/json
x-frame-options: SAMEORIGIN
x-content-type-options: nosniff
permissions-policy: interest-cohort=()
x-cloud-trace-context: 65e39d11c377a9ff86e0a8b01ae5a9a0;o=1
date: Sun, 11 Feb 2024 01:35:41 GMT
server: Google Frontend
content-length: 4
alt-svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
root âœ /workspaces/rust-api-samples-rocket/rocket (main) $
```

- bucket ã«ã¯ `generations` folder ãŒä½œæˆã•ã‚Œã‚‹ã€‚
```bash
yamamoto_daisuke@cloudshell:~ (hoge-334000)$ gsutil ls gs://litetodo/local.db/*/*
gs://litetodo/local.db/generations/3d1cedda7f76e794/:
gs://litetodo/local.db/generations/3d1cedda7f76e794/snapshots/
gs://litetodo/local.db/generations/3d1cedda7f76e794/wal/

gs://litetodo/local.db/generations/71eaf42511de8f63/:
gs://litetodo/local.db/generations/71eaf42511de8f63/snapshots/
gs://litetodo/local.db/generations/71eaf42511de8f63/wal/

gs://litetodo/local.db/generations/9240f1ff1ffe3b9d/:
gs://litetodo/local.db/generations/9240f1ff1ffe3b9d/snapshots/
gs://litetodo/local.db/generations/9240f1ff1ffe3b9d/wal/

gs://litetodo/local.db/generations/dcfb5d0db3c4b6d8/:
gs://litetodo/local.db/generations/dcfb5d0db3c4b6d8/snapshots/
gs://litetodo/local.db/generations/dcfb5d0db3c4b6d8/wal/
yamamoto_daisuke@cloudshell:~ (hoge-334000)$ 
```

ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/rust-api-samples-rocket

## BTW
èŠ±ç²‰ã®å­£ç¯€ãŒåˆ°æ¥ ğŸŒ²

ãƒ•ãƒ©ã‚¯ãƒˆã‚ªãƒªã‚´ç³–ã‚’æ‘‚å–ã™ã‚‹ç”Ÿæ´»ã‚’å†é–‹ã™ã‚‹ã€‚å€‹äººçš„ã«å»å¹´ã€åŠ¹æœãŒã‚ã£ãŸã®ã§ä»Šå¹´ã‚‚ç¶™ç¶šã™ã‚‹ã€‚

[^1]: https://litestream.io/getting-started/
[^2]: https://rocket.rs/v0.5/guide/requests/#body-data
