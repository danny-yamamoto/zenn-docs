---
title: "Deploy Next.js Monorepo using Turborepo on AWS Amplify Gen 2"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["turborepo", "amplify", "typescript", "nestjs", "nextjs"]
published: true
---
AWS Amplify Gen 2 (Amplify) ã«ã¤ã„ã¦ã€‚

ã“ã®è¨˜äº‹ã‚’æ›¸ãã«ã‚ãŸã‚Šã€å‰æã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
- Amplify ã®æ¤œè¨¼ä¸­ã§ã™ã€‚
- Monorepo ã‚’æ¤œè¨ä¸­ã§ã™ã€‚
- é–‹ç™ºè¨€èªã¯ Monorepo å…¨ä½“ã§ TypeScript ã‚’ä½¿ã„ã¾ã™ã€‚
- Monorepo tool ã® Nx[^2] ã‚’æ¤œè¨¼æ¸ˆã¿ã§ã™ã€‚

Nx ã®å ´åˆã€ Amplify ã® Framework è‡ªå‹•æ¤œå‡ºã§èª²é¡ŒãŒã‚ã‚‹ã€‚

Amplify ã®æŒ™å‹•ã‹ã‚‰ root ã® `package.json` ã‚’ã‚‚ã¨ã« Framework ã‚’åˆ¤å®šã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚5æœˆ22æ—¥æ™‚ç‚¹ã€‚

ã—ã‹ã—ã€Monorepo ã®å ´åˆã€Frontend ã¨ Backend ã§ç•°ãªã‚‹ Framework ã‚’é¸æŠã™ã‚‹ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ã€‚

ãã“ã§ Turborepo[^1] ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

https://turbo.build/repo

Code ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/coconut

## tl;dr
- Turborepo ã§å•é¡Œãªãæ§‹ç¯‰ã§ããŸã€‚ï¼ˆ5æœˆ22æ—¥æ™‚ç‚¹ï¼‰
- Amplify ã® Framework è‡ªå‹•æ¤œå‡ºã®èª²é¡Œã«ã¤ã„ã¦ã¯ã‚µãƒãƒ¼ãƒˆã«å•ã„åˆã‚ã›ä¸­ã€‚
- Nx ã§ã‚‚ Deploy ã®é †ç•ªã¨ `package.json` ã®ä¿®æ­£ã‚’è¡Œãˆã°ã€Deploy ã¯å¯èƒ½ã€‚ä»Šã®ã‚„ã‚Šæ–¹ã¯ã€ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ Hack ã½ããªã‚‹ã®ã§è§£æ±ºç­–ã‚’æ¢ã—ãŸã„ã€‚

## Create a workspace
- Package manager ã¯ `npm` ã‚’é¸æŠã€‚
- `pnpm` ã®å ´åˆã¯ã€Amplify ã® build ã§ä¸€å·¥å¤«å¿…è¦ã‚‰ã—ã„ã€‚[^4]
- `coconut` ã¨åä»˜ã‘ãŸã®ã¯ã€ãƒªãƒ³ã‚´é£´ã® Flavor ã‹ã‚‰ã€‚ã“ã®æ•°å¹´ã€å®¶æ—ãŒãƒªãƒ³ã‚´é£´ã«ãƒãƒã£ã¦ã„ã‚‹ã€‚ã©ã†ã§ã‚‚ã„ã„è©±ã€‚ğŸ
- Workspace ã®ä½œæˆã¯ Quickstart[^5] ã‚’å‚ç…§ã€‚

```bash
vscode âœ /workspaces/stool/tourborepo (main) $ npx create-turbo@latest
Need to install the following packages:
create-turbo@1.13.3
Ok to proceed? (y) y

>>> TURBOREPO

>>> Welcome to Turborepo! Let's get you set up with a new codebase.

? Where would you like to create your turborepo? coconut
? Which package manager do you want to use? npm workspaces

Downloading files. This might take a moment.

>>> Created a new Turborepo with the following:

apps
 - apps/docs
 - apps/web
packages
 - packages/eslint-config
 - packages/typescript-config
 - packages/ui

Installing packages. This might take a couple of minutes.

>>> Success! Created a new Turborepo at "coconut".
Inside that directory, you can run several commands:

  npm run build
     Build all apps and packages

  npm run dev
     Develop all apps and packages

  npm run lint
     Lint all apps and packages

Turborepo will cache locally by default. For an additional
speed boost, enable Remote Caching with Vercel by
entering the following command:

  npx turbo login

We suggest that you begin by typing:

  cd coconut
  npx turbo login

vscode âœ /workspaces/stool/tourborepo (main) $ 
```

## Frontend
- Generate ã•ã‚ŒãŸ `web` App ã‚’ãã®ã¾ã¾ Deploy ã™ã‚‹ã€‚

### Amplify Manual Settings
- Amplify ã® Offical docs[^3] ã‚’å‚è€ƒã«ã™ã‚‹ã€‚
- `workspace` ã« `web` Project ã‚’æŒ‡å®šã™ã‚‹ã€‚
```bash
npm install --save-dev @aws-amplify/backend@latest @aws-amplify/backend-cli@latest typescript --workspace=web
npm install --save-dev @aws-amplify/backend-cli aws-amplify @aws-amplify/ui-react --workspace=web
```

### Run Next.js
```bash
cd /workspaces/coconut/apps/web
npm run dev
```

```bash
node âœ /workspaces/coconut/apps/web (main) $ npm run dev

> web@1.0.0 dev
> next dev

  â–² Next.js 14.2.3
  - Local:        http://localhost:3000

 âœ“ Starting...
 âœ“ Ready in 6.2s
 â—‹ Compiling / ...
(node:29092) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 âœ“ Compiled / in 7.2s (552 modules)
 GET / 200 in 7416ms
```

![nextjs](/images/d65ad82ffea052-a.png)

## Backend
### Setup NestJS
- CLI ã§ Project ã‚’ä½œæˆã™ã‚‹ã€‚
```bash
cd /workspaces/coconut/
npm i -g @nestjs/cli
nest new backend
```

### Amplify Manual Settings
- `workspace` ã« `backend` Project ã‚’æŒ‡å®šã™ã‚‹ã€‚
```bash
npm install --save-dev @aws-amplify/backend@latest @aws-amplify/backend-cli@latest typescript --workspace=backend
npm install --save-dev @aws-amplify/backend-cli aws-amplify @aws-amplify/ui-react --workspace=backend
```

### Run NestJS
```bash
cd /workspaces/coconut/apps/backend
npm run start
```

```bash
node âœ /workspaces/coconut/apps/backend (main) $ npm run start

> backend@0.0.1 start
> nest start

[Nest] 61511  - 05/22/2024, 10:40:58 AM     LOG [NestFactory] Starting Nest application...
[Nest] 61511  - 05/22/2024, 10:40:58 AM     LOG [InstanceLoader] AppModule dependencies initialized +23ms
[Nest] 61511  - 05/22/2024, 10:40:58 AM     LOG [RoutesResolver] AppController {/}: +45ms
[Nest] 61511  - 05/22/2024, 10:40:58 AM     LOG [RouterExplorer] Mapped {/, GET} route +3ms
[Nest] 61511  - 05/22/2024, 10:40:58 AM     LOG [NestApplication] Nest application successfully started +3ms
```

## Deploy to Amplify
- Amplify ã® Console ã‹ã‚‰ Deploy ã™ã‚‹ã€‚Nx ã®å ´åˆã¨ã¯ç•°ãªã‚Šã€Framework ã®è‡ªå‹•åˆ¤å®šã¯å•é¡Œãªã„ã€‚
- Nx ã®å ´åˆã¯ã€`artifacts` `buildPath` ã®ä¿®æ­£ãŒå¿…è¦ã ã£ãŸã€‚

```yaml:Frontend | amplify.yml
version: 1
applications:
  - backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
    frontend:
      phases:
        preBuild:
          commands:
            - npx npm install
        build:
          commands:
            - npx turbo run build --filter=web
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - .next/cache/**/*
          - node_modules/**/*
      buildPath: apps/web
    appRoot: apps/web
```

```yaml:Backend | amplify.yml
version: 1
applications:
  - backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
    frontend:
      phases:
        preBuild:
          commands:
            - npx npm install
        build:
          commands:
            - npx turbo run build --filter=backend
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
      buildPath: apps/backend
    appRoot: apps/backend
```

## BTW
æœ€è¿‘ã¯ã“ã®è€ƒãˆæ–¹ã«ãªã£ãŸã€‚

è‡ªåˆ†ã«é›†ä¸­ã™ã‚‹ã€‚è‡ªåˆ†ã«æœŸå¾…ã™ã‚‹ã€‚

ä»–äººã«æœŸå¾…ã—ãªã„ã€‚ä»–äººãŒå‡ºæ¥ã‚‹ã“ã¨ã‚’çŸ¥ã‚‹ã€‚ä»–è€…ã‚’åŠ´ã†ã€‚

ç›®æŒ‡ã™æ–¹å‘ãŒåŒã˜äººã¨æˆæœã‚’ç¥ã„ãªãŒã‚‰æ™‚ã«ã¯è»Œé“ä¿®æ­£ã—ç›®æ¨™ã«å‘ã‹ã†ã€‚

è¦ã™ã‚‹ã«è‡ªåˆ†ãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å‡ºæ¥ã‚‹ã“ã¨ã«é›†ä¸­ã™ã‚‹ã“ã¨ã€‚


[^1]: https://turbo.build/repo
[^2]: https://nx.dev/
[^3]: https://docs.amplify.aws/react/start/manual-installation/#manual-setup
[^4]: https://docs.aws.amazon.com/amplify/latest/userguide/monorepo-configuration.html#turborepo-pnpm-monorepo-configuration
[^5]: https://turbo.build/repo/docs/getting-started/create-new
