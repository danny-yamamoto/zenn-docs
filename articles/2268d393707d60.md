---
title: "Deploy Next.js Monorepo using Nx on AWS Amplify Gen 2."
emoji: "ğŸª¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["amplify", "nx", "typescript", "nextjs", "monorepo"]
published: true
---
AWS Amplify Gen 2 (Amplify) ã«ã¤ã„ã¦

![alt text](/images/2268d393707d60-d.png)

GA ã«ãªã£ãŸãŸã‚ã€ä½¿ã„æ–¹ã‚’å­¦ã‚“ã§ã„ã

https://aws.amazon.com/jp/about-aws/whats-new/2024/05/aws-amplify-gen-2-available/

é€²ã‚ã‚‹ã«ã‚ãŸã‚Šã€å‰æã¯ä»¥ä¸‹ã®é€šã‚Š
- TypeScript ã® Monorepo
- Managed Service ã‚’ä½¿ã†ã€‚æ¥µåŠ›

Code ã¯ã“ã‚Œ

https://github.com/danny-yamamoto/candy

## Configure Monorepo
https://nx.dev/

- Nx[^1] ã‚’ä½¿ç”¨ã™ã‚‹ã€‚Turborepo[^2] ã«ã‚‚èˆˆå‘³ãŒã‚ã‚‹
    - Org: `candy`
    - Next.js
    - e2e: Playwright
    - CSS: Tailwind CSS

```bash
npx create-nx-workspace
```

```bash
npx nx build front-a
npx nx start front-a
```

## Install Amplify dependencies[^3]
- Nx ã« Amplify é–¢é€£ã® dependencies ã‚’è¿½åŠ ã™ã‚‹

```bash
npx nx add @aws-amplify/backend-cli aws-amplify @aws-amplify/ui-react
npx nx add @aws-amplify/backend
npx nx add @aws-amplify/ui-react
npx nx add aws-cdk-lib
```

- å…¬å¼ã® template ã‹ã‚‰ Code ã‚’æŒã£ã¦ãã‚‹

https://github.com/aws-samples/amplify-next-template

## Monorepo ã‚’ deploy ã™ã‚‹
- Console ã«å¾“ã†ã€‚ãƒ¢ãƒãƒ¬ãƒã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ Directory ã‚’å…¥åŠ›ã™ã‚‹ `apps/front-a`
- Build è¨­å®šã‚’ä¸€éƒ¨å¤‰æ›´ã™ã‚‹
    - Before: `buildPath: dist/apps/front-a`
    - After: `buildPath: apps/front-a`

![alt text](/images/2268d393707d60-e.png)

```bash: error log
2024-05-20T00:08:56.701Z [INFO]: # Cloning repository: git@github.com:danny-yamamoto/candy.git
2024-05-20T00:08:57.692Z [INFO]:
2024-05-20T00:08:57.692Z [INFO]: Cloning into 'candy'...
2024-05-20T00:08:57.693Z [INFO]: # Checking for Git submodules at: /codebuild/output/src/src/candy/.gitmodules
2024-05-20T00:08:57.703Z [ERROR]: !!! CustomerError: Build path does not exist, please check the 'buildPath' value in BuildSpec
2024-05-20T00:08:57.703Z [INFO]: # Starting environment caching...
2024-05-20T00:08:57.703Z [INFO]: # Environment caching completed
```

```yaml:amplify.yml
version: 1
applications:
  - backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
    frontend:
      phases:
        build:
          commands:
            - npx nx build front-a
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - .next/cache/**/*
          - .npm/**/*
      buildPath: apps/front-a
    appRoot: apps/front-a
```

## Tips
- Amplify ç‰¹æœ‰ã®è¨­å®šã§ã™ã€‚Amplify ãƒ•ã‚©ãƒ«ãƒ€ãŒå¿…è¦ã§ã€ãã“ã« resource ã‚’è¿½åŠ ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹

https://github.com/danny-yamamoto/candy/blob/357e3184edb54f4d4412ae2715a99d91fd2fd4f0/apps/front-a/app/page.tsx#L5
https://github.com/danny-yamamoto/candy/blob/357e3184edb54f4d4412ae2715a99d91fd2fd4f0/apps/front-a/app/page.tsx#L8-L9

- GraphQL ã® Playground ãŒä»˜ã„ã¦ãã‚‹
![alt text](/images/2268d393707d60-f.png)

## BTW
è»¢è·ã—ã¦ 2 ãƒ¶æœˆãŒéãã‚ˆã†ã¨ã—ã¦ã„ã‚‹

å€‹äººçš„ã«ã¯ Mission ã¸ã®å…±æ„Ÿã¯æ—¥ã«æ—¥ã«å¢—ã—ã¦ã„ã‚‹

ãã—ã¦ã€ãŠäº’ã„ã‚’åŠ´ã„ã€æœ›ã¾ã—ã„è¨€å‹•ã«å ±é…¬ã‚’é€ã‚Šåˆã†åˆ¶åº¦ã¯ã€Value ã‚’ã‚ˆã‚Šå¼·åŒ–ã—ã¦ã„ã‚‹ã¨æ€ã†

ç§ã«ã¨ã£ã¦ã€Respect ã—åˆãˆã‚‹ Member ã®å­˜åœ¨ã“ããŒæœ€å¤§ã®ç¦åˆ©åšç”Ÿã ã¨æ€ã†ã€‚ç¦åˆ©åšç”Ÿã‚„å ±é…¬ã«ç›®ãŒå‘ããŒã¡ã§ã™ãŒ


[^1]: https://nx.dev/
[^2]: https://turbo.build/
[^3]: https://docs.amplify.aws/react/deploy-and-host/fullstack-branching/mono-and-multi-repos/
