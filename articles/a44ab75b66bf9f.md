---
title: "Self-hosted GitHub Actions runners for automated Amazon ECS deployment"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["actions", "codebuild", "ecs", "docker"]
published: true
---

Code ã®ä¿®æ­£ã‚’ Trigger ã«ã—ãŸ Amazon ECS ( ECS ) ã¸ã® Deploy ã«ã¤ã„ã¦ã€‚

å‚è€ƒã«ã—ãŸã®ã¯ã€GitHub ã®å…¬å¼ã€‚

https://docs.github.com/ja/actions/use-cases-and-examples/deploying/deploying-to-amazon-elastic-container-service#creating-the-workflow

æ§‹æˆã¯ã€ã“ã‚“ãªæ„Ÿã˜

```mermaid
flowchart TD
    subgraph AWS
        subgraph ECS
            task_def["Task Definition"]
            service["Service"]
            Task
        end
        ECR
        codebuild[CodeBuild]
        ALB
    end
    subgraph github[GitHub]
        src[Src]
        subgraph environments[Environments]
            development[Development]
            staging[Staging]
            production[Production]
        end
        subgraph Actions
            docker_build["docker build"]
            describe_task_def["aws ecs describe-task-definition"]
            amazon_ecs_render_task_def["amazon-ecs-render-task-definition"]
            amazon_ecs_deploy_task_def["amazon-ecs-deploy-task-definition"]
            Json
        end
    end
    Developer -->|Commit| src
    src -->|Trigger| Actions
    docker_build --> describe_task_def
    describe_task_def --> Json
    docker_build -->|Push image| ECR
    describe_task_def --> amazon_ecs_render_task_def
    amazon_ecs_render_task_def --> amazon_ecs_deploy_task_def
    amazon_ecs_render_task_def -->|æ–°ã—ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®ä½œæˆ| task_def
    Json --> amazon_ecs_render_task_def
    ECR -->|Pull image| Task
    amazon_ecs_deploy_task_def -->|ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°| service
    task_def --> service
    service --> Task
    ALB --> Task
    Tester --> ALB
    environments --> Actions
```

## Sum up

- k8s ã§ ArgoCD ãªã©ã® GitOps ã§é‹ç”¨ã—ã¦ã„ã‚‹å ´åˆã€Helm chart ã® yaml ã‚’æ›´æ–°ã—ãŸã‚‰çµ‚ã‚ã‚Šã®ãŸã‚ã€æ¥½ã§ã¯ã‚ã‚‹ã€‚
- ä¸€æ–¹ã€k8s ã‚„å‘¨è¾ºã® ecosystem ã®æ›´æ–°ã«è¿½ã‚ã‚Œã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ ECS ã®æ–¹ãŒå¥åº·çš„ã«éã”ã›ã‚‹ã‚ˆãªã¨ã„ã†ã®ã¯æ­£ç›´ã‚ã‚‹ã€‚


## ç’°å¢ƒå¤‰æ•°

- Self-hosted ã«ãŠã„ã¦ã€ç’°å¢ƒå¤‰æ•°ã¯ã€GitHub ã® `Environments` ã«è¨­å®šã™ã‚‹ã€‚CodeBuild ã®ç’°å¢ƒå¤‰æ•°ã¯ä½¿ãˆãªã„ã€‚
    - GitHub `Environments` ã¯ã€2021å¹´ã«ç™»å ´ã—ãŸæ©Ÿèƒ½ã‚‰ã—ã„ã€‚
    - å‰è·ã§ã¯ã€Cloud Build ã‚’ãƒ¡ã‚¤ãƒ³ã§ä½¿ç”¨ã—ã¦ã„ãŸã€‚Managed Service ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã—ãŸã€‚
    - ç†ç”±ã¯ã€Actions ã®å®¹é‡ã‚’è¶…ãˆã¦ã€Build ã‚„ Deploy ãŒåœæ­¢ã™ã‚‹ã“ã¨ãŒå¤šç™ºã—ãŸãŸã‚ã€‚

![settings](/images/d6b7e8a94a492e-a.png)

## Workflow

- å¤‰æ›´ç‚¹ã€‚Json ã‚’å‡ºåŠ›ã—ã¦ã€æœ€æ–°ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä½¿ã„å›ã™ã€‚

```yaml: .github/workflows/build-hoge-api.yml
      - name: Latest ECS task definition Json
        id: create-json
        run: aws ecs describe-task-definition --task-definition ${{ env.ECS_TASK_DEFINITION_ARN }} --query taskDefinition > taskdefinition.json

      - name: Fill in the new image ID in the Amazon ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: taskdefinition.json
          container-name: api
          image: ${{ steps.build-image.outputs.image }}
```

## Conclusion

ä¸­å­¦æ ¡ã®è·å ´ä½“é¨“ã«åœ¨å®… programmer ã‚’ãŠå‹§ã‚ã—ã¾ã—ãŸãŒã€ç¬‘ã£ã¦ã‚¹ãƒ«ãƒ¼ã•ã‚Œã¾ã—ãŸ

