---
title: "Mocking in Schema-Driven Development"
emoji: "ğŸ¦œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["wiremock", "nextjs", "nestjs", "devcontainers", "rest"]
published: false
---

kubell Advent Calendar 2024 ã®æŠ•ç¨¿ã§ã™ã€‚ [^1]

https://qiita.com/advent-calendar/2024/kubell

ã“ã®æŠ•ç¨¿ã§ã¯ã€ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã¨ Mocking ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## tl;dr

- å¤–éƒ¨ API ã¸ã®ä¾å­˜ã¨ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã«ãŠã‘ã‚‹èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€WireMock [^2] ã‚’æ´»ç”¨
- WireMock ã¯ã€API ãƒ¢ãƒƒã‚¯ ãƒ†ã‚¹ãƒˆç”¨ã®äººæ°—ã®ã‚ªãƒ¼ãƒ—ãƒ³ ã‚½ãƒ¼ã‚¹ ãƒ„ãƒ¼ãƒ«
- WireMock ã‚’ Dev Containers ã¨ Docker ç’°å¢ƒã«çµ±åˆ
- é–‹ç™º / QA ç’°å¢ƒã®å®‰å®šæ€§ã¨ä¸€è²«æ€§ã‚’ç¢ºä¿
- WireMock ã® Proxy ãƒ¢ãƒ¼ãƒ‰ã®æ´»ç”¨ã«ã‚ˆã‚Šã€å®Ÿ API ã¨ Mock ã®æŸ”è»Ÿãªåˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½

https://wiremock.org/

```mermaid
flowchart TD
    browser[Browser]
    subgraph ide["VS Code"]
        subgraph devcon[Dev Containers]
            subgraph docker_mock["Docker | WireMock"]
                any["/.*"]
                users[user]
            end
            subgraph docker_db[Docker]
                db[(Database)]
            end
            subgraph docker_monorepo["Docker | Node.js"]
                subgraph render["Server-side Rendering"]
                    user
                    company
                end
                api[API]
            end
        end
    end
    developer -->|localhost:3001| browser
    browser --> render
    user -->|Request| users
    company -->|Request| any
    any -->|Proxy| api
    api -->|Query| db
    classDef kubell fill:#f04600,stroke:#000000,stroke-width:2px;
    style docker_mock fill:#f04600
```

## å‰æ

### BPaaS ã‚µãƒ¼ãƒ“ã‚¹

- ç§ãŸã¡ã¯ BPaaS ã®ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚æ—©æœŸã®å°å…¥ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
- BPaaS ã¯ã€ãƒãƒ£ãƒƒãƒˆçµŒç”±ã§ä¼šè¨ˆã€åŠ´å‹™ã€ç·å‹™ãªã©æ§˜ã€…ãªãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ã‚’ã‚¢ã‚¦ãƒˆã‚½ãƒ¼ã‚¹ã§ãã‚‹ã€ŒChatwork ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

https://assistant.chatwork.com/?adcode=orgic_platf_cwassistant_gm-om_corporate&utm_source=gm-om&utm_medium=corporate&utm_campaign=cwassistant&utm_term=non&utm_content=cid25

### ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™º

- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚„ API ã®è¨­è¨ˆã‚’æœ€åˆã« Schema ã¨ã—ã¦å®šç¾©ã—ã€ãã‚Œã‚’ä¸­å¿ƒã«é–‹ç™ºã‚’é€²ã‚ã¾ã™ã€‚
- ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–‹ç™ºã‚’ä¸¦è¡Œã—ã¦åŠ¹ç‡çš„ã«é–‹ç™ºã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant FD as Frontend Developer
    participant BD as Backend Developer
    participant Ent as NestJS & Prisma
    participant DB as Database
    participant OA as OpenAPI
    participant CL as Zod API Client
    participant SW as Swagger
    participant ORM as ORM
    participant FA as Frontend App
    participant BA as Backend API

    BD->>Ent: 1. ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ
    FD->>Ent: 2. PR review
    
    par Generation
        Ent-->>DB: 3a. migrate
        Ent-->>OA: 3b. generate
        OA-->>CL: 3c. generate
        OA-->>SW: 3d. generate
        Ent-->>ORM: 3e. generate
    end
    
    par Parallel Development
        FD->>FA: 4a. å®Ÿè£…
        FD->>SW: 4b. å‚ç…§
        BD->>BA: 4c. API å®Ÿè£…
    end
    
    FA->>CL: import
    BA->>ORM: import
```

## èª²é¡Œ

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã‚’é€²ã‚ã‚‹ä¸­ã§ã€é–‹ç™ºåŠ¹ç‡ã¨ãƒ†ã‚¹ãƒˆã®ä¿¡é ¼æ€§ã«é–¢ã™ã‚‹ 2 ã¤ã®èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

### å¤–éƒ¨ API ä¾å­˜ãƒ†ã‚¹ãƒˆã«ãŠã‘ã‚‹ä¿¡é ¼æ€§å‘ä¸Š

- 1ã¤ç›®ã¯ã€å¤–éƒ¨ API ã«ä¾å­˜ã—ãŸãƒ†ã‚¹ãƒˆã®è„†å¼±æ€§ã§ã™ã€‚
- ä¸€éƒ¨ã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãŒå¤–éƒ¨ API ã®å‘¼ã³å‡ºã—ã‚’å¿…è¦ã¨ã—ã¦ã„ã¾ã™ã€‚å¤–éƒ¨ API ã®äºˆæœŸã›ã¬åœæ­¢ã‚„å¤‰æ›´ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šã«ãªã‚‹ãƒªã‚¹ã‚¯ã‚’æŠ±ãˆã¦ã„ã¾ã—ãŸã€‚

### ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã«ãŠã‘ã‚‹ãƒ¢ãƒƒã‚¯å¿…è¦æ€§

- 2ã¤ç›®ã®èª²é¡Œã¯ã€ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã«é–¢ã™ã‚‹ã‚‚ã®ã§ã—ãŸã€‚
- ç§ãŸã¡ã¯ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä¸¦è¡Œã—ã¦é–‹ç™ºã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚Backend API ã®å®Ÿè£…ãŒå®Œäº†ã™ã‚‹ã¾ã§ã®é–“ã€é©åˆ‡ãªãƒ¢ãƒƒã‚¯ãŒå¿…é ˆã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚
- é–‹ç™ºãƒ•ãƒ­ãƒ¼ã«ãŠã„ã¦ã€ã“ã®èª²é¡Œã«å¯¾ã™ã‚‹åŠ¹ç‡çš„ãªè§£æ±ºç­–ãŒå¿…è¦ã§ã—ãŸã€‚

## è§£æ±ºç­–

- ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ç§ãŸã¡ã¯ WireMock Standalone ( Running in Docker ) [^3] ã‚’æ´»ç”¨ã—ã¾ã—ãŸã€‚ç§è‡ªèº«ã®å‰è·ã§ã® WireMock ä½¿ç”¨çµŒé¨“ã‹ã‚‰ã€ç¾åœ¨ã®èª²é¡Œã«æœ€é©ãªãƒ„ãƒ¼ãƒ«ã ã¨æ€ã„ææ¡ˆã—ã¾ã—ãŸã€‚
- Dev Containers ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹é–‹ç™ºç’°å¢ƒã«ãŠã„ã¦ã€WireMock ã‚’ Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦èµ·å‹•ã™ã‚‹æ§‹æˆã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

```bash
.
â””â”€â”€ .devcontainer
    â”œâ”€â”€ devcontainer.env
    â”œâ”€â”€ devcontainer.json
    â”œâ”€â”€ docker-compose.yml
    â”œâ”€â”€ Dockerfile
    â””â”€â”€ wiremock
        â”œâ”€â”€ __files
        â”‚   â””â”€â”€ user.json
        â”œâ”€â”€ mappings
        â”‚   â””â”€â”€ any.json
        â””â”€â”€ README.md
```

```yml:docker-compose.yml
  wiremock:
    image: wiremock/wiremock:3.9.1
    volumes:
      - ./wiremock/__files:/home/wiremock/__files
      - ./wiremock/mappings:/home/wiremock/mappings
    entrypoint:
      [
        '/docker-entrypoint.sh',
        '--global-response-templating',
        '--disable-gzip',
        '--verbose',
      ]
```

- ç‰¹ã«é‡è¦ãªç‚¹ã¯ã€WireMock ã‚’ Proxy ã¨ã—ã¦ä½¿ç”¨ã—ãŸã“ã¨ã§ã™ã€‚WireMock ã«å®šç¾©ã•ã‚Œã¦ã„ãªã„ Requests ã¯å®Ÿéš›ã® Backend API Server ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚ã“ã®æ§‹æˆã¯é–‹ç™ºç’°å¢ƒã¨ QA ç’°å¢ƒã§çµ±ä¸€ã—ã¾ã—ãŸã€‚

> Proxying
> WireMock has the ability to selectively proxy requests through to other hosts. This supports a proxy/intercept setup where requests are by default proxied to another (possibly real, live) service, but where specific stubs are configured these are returned in place of the remote serviceâ€™s response. Responses that the live service canâ€™t be forced to generate on demand can thus be injected for testing. Proxying also supports record and playback.ã€€[^4]

```json:any.json
{
  "priority": 99999,
  "request": {
    "urlPattern": "/.*"
  },
  "response": {
    "proxyBaseUrl": "http://localhost:3000"
  }
}
```

- QA ç’°å¢ƒã§ã¯ AWS ECS ä¸Šã« Mock ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚Endpoint ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ã§ã€ä¸€è²«ã—ãŸé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```json
    "containerDefinitions": [
        {
            "name": "wiremock",
            "image": "wiremock/wiremock:3.9.1",
            "cpu": 0,
            "portMappings": [
                {
                    "containerPort": 8080,
                    "hostPort": 8080,
                    "protocol": "tcp"
                }
            ],
            "essential": true,
            "mountPoints": [],
            "volumesFrom": [],
            "readonlyRootFilesystem": true,
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-group": "hoge",
                    "awslogs-region": "ap-northeast-1",
                    "awslogs-stream-prefix": "wiremock"
                }
            },
            "systemControls": []
        }
    ],
```

- é–‹ç™ºè€…ãŒ Mock ã® Response ã‚’å®¹æ˜“ã«è­˜åˆ¥ã§ãã‚‹ã‚ˆã†ã€Response ã®å†…å®¹ã«æ˜ç¤ºçš„ãª Marker ã‚’å«ã‚ã¾ã—ãŸã€‚

### é–‹ç™ºãƒ•ãƒ­ãƒ¼

1. é–‹ç™ºãƒãƒ¼ãƒ ã§ REST API ã® Schema ã‚’æ±ºå®š
1. Response ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„
1. æº–å‚™ã—ãŸ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ WireMock ã®è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
1. WireMock ã‚’ Reset `curl -X POST http://localhost:8080/__admin/mappings/reset`
1. æ–°ã—ã„ Mock ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹

### Summary

- WireMock ã®æ´»ç”¨ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã®å®‰å®šæ€§ãŒå‘ä¸Šã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸¦è¡Œé–‹ç™ºãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã—ãŸã€‚
- å¤–éƒ¨ API ã¸ã®ä¾å­˜åº¦ã‚’ä¸‹ã’ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šä¿¡é ¼æ€§ã®é«˜ã„é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

---

è¨˜äº‹ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ã„ãŸã ã„æ–¹ã¯ã„ã„ã­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ğŸ‘‹


[^1]: 2024å¹´7æœˆ1æ—¥ã€Chatworkæ ªå¼ä¼šç¤¾ã¯æ ªå¼ä¼šç¤¾kubellã¸ã¨ç¤¾åå¤‰æ›´ã—ã¾ã—ãŸã€‚

[^2]: https://wiremock.org/docs/

[^3]: https://wiremock.org/docs/standalone/docker/

[^4]: https://wiremock.org/docs/proxying/
