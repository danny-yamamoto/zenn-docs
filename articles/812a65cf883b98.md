---
title: "Mocking in Schema-Driven Development"
emoji: "ğŸ¦œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["wiremock", "nextjs", "nestjs", "devcontainers", "rest"]
published: true
---

kubell Advent Calendar 2024 ã®æŠ•ç¨¿ã§ã™ã€‚ [^1]

https://qiita.com/advent-calendar/2024/kubell

ã“ã®æŠ•ç¨¿ã§ã¯ã€ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã¨ Mocking ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

```mermaid
flowchart TD
    %% ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    browser["ğŸŒ Browser"]
    developer["ğŸ‘¨â€ğŸ’» Developer"]

    %% VS Codeç’°å¢ƒã®ã‚µãƒ–ã‚°ãƒ©ãƒ•
    subgraph ide ["VS Code"]
        direction TB
        
        %% Dev Containersã®ã‚µãƒ–ã‚°ãƒ©ãƒ•
        subgraph devcon ["Dev Containers"]
            direction TB
            
            %% WireMockã‚³ãƒ³ãƒ†ãƒŠ
            subgraph docker_mock ["WireMock Container"]
                direction LR
                any["/.*"]
                users["Users API Mock"]
            end
            
            %% ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒŠ
            subgraph docker_db ["Database Container"]
                db[(Database)]
            end
            
            %% ãƒ¢ãƒãƒ¬ãƒã‚³ãƒ³ãƒ†ãƒŠ
            subgraph docker_monorepo ["Node.js Container"]
                direction TB
                subgraph render ["ğŸ–¥ï¸ Server-side Rendering"]
                    user["User Service"]
                    company["Company Service"]
                end
                api["Backend API"]
            end
        end
    end

    %% ãƒ•ãƒ­ãƒ¼å®šç¾©
    developer -->|"localhost:3001"| browser
    browser --> render
    user -->|"Request"| users
    company -->|"Request"| any
    any -->|"Proxy"| api
    api -->|"Query"| db

    %% ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
    classDef default fill:#f9f9f9,stroke:#333,stroke-width:1px
    classDef container fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef service fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef database fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef mock fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    %% ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    class docker_mock,docker_db,docker_monorepo container
    class user,company,api service
    class db database
    class users,any mock
```

```bash
â–ˆâ–ˆ     â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ 
â–ˆâ–ˆ     â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ  
â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   
â–ˆâ–ˆ â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ  
 â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ 

----------------------------------------------------------------
|               Cloud: https://wiremock.io/cloud               |
|                                                              |
|               Slack: https://slack.wiremock.org              |
----------------------------------------------------------------
```

## tl;dr

- å¤–éƒ¨ API ã¸ã®ä¾å­˜ã¨ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã«ãŠã‘ã‚‹èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€WireMock [^2] ã‚’æ´»ç”¨
- WireMock ã¯ã€API ãƒ¢ãƒƒã‚¯ ãƒ†ã‚¹ãƒˆç”¨ã®äººæ°—ã® OSS
- WireMock ã‚’ Dev Containers ã¨ Docker ç’°å¢ƒã«çµ±åˆ
- é–‹ç™º / QA ç’°å¢ƒã®å®‰å®šæ€§ã¨ä¸€è²«æ€§ã‚’ç¢ºä¿
- WireMock ã® Proxy ãƒ¢ãƒ¼ãƒ‰ã®æ´»ç”¨ã«ã‚ˆã‚Šã€å®Ÿ API ã¨ Mock ã®æŸ”è»Ÿãªåˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½

https://wiremock.org/

## å‰æ

### BPaaS ã‚µãƒ¼ãƒ“ã‚¹

- BPaaS ã¯ã€ãƒãƒ£ãƒƒãƒˆçµŒç”±ã§ä¼šè¨ˆã€åŠ´å‹™ã€ç·å‹™ãªã©æ§˜ã€…ãªãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ã‚’ã‚¢ã‚¦ãƒˆã‚½ãƒ¼ã‚¹ã§ãã‚‹ã€ŒChatwork ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
- ç§ãŸã¡ã¯ BPaaS ã®ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚ã„ã¡æ—©ããƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ã€ä¾¡å€¤ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

https://assistant.chatwork.com/?adcode=orgic_platf_cwassistant_gm-om_corporate&utm_source=gm-om&utm_medium=corporate&utm_campaign=cwassistant&utm_term=non&utm_content=cid25

### REST ã‚’é¸æŠã—ãŸèƒŒæ™¯

- REST vs. GraphQL vs. gRPC
- é–‹ç™ºã®åŠ¹ç‡æ€§ã‚’é‡è¦–ã—ã€ãƒ¡ãƒ³ãƒãƒ¼ã®çµŒé¨“ãŒå¤šã„ REST ãŒç¾çŠ¶ã¯æœ€é©ã ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚

### ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™º

- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚„ API ã®è¨­è¨ˆã‚’æœ€åˆã« Schema ã¨ã—ã¦å®šç¾©ã—ã€ãã‚Œã‚’ä¸­å¿ƒã«é–‹ç™ºã‚’é€²ã‚ã¾ã™ã€‚
- ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–‹ç™ºã‚’ä¸¦è¡Œã—ã¦åŠ¹ç‡çš„ã«é–‹ç™ºã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```mermaid
sequenceDiagram
    autonumber
    participant FD as ğŸ‘¨â€ğŸ’» Frontend<br/>Developer
    participant BD as ğŸ‘©â€ğŸ’» Backend<br/>Developer
    participant Ent as ğŸ—ï¸ NestJS &<br/>Prisma
    participant DB as ğŸ’¾ Database
    participant OA as ğŸ“˜ OpenAPI
    participant CL as ğŸ”„ Zod API<br/>Client
    participant SW as ğŸ“š Swagger
    participant ORM as ğŸ”Œ ORM
    participant FA as ğŸ–¥ï¸ Frontend<br/>App
    participant BA as âš¡ Backend<br/>API

    rect rgb(240, 248, 255)
        Note over BD,Ent: è¨­è¨ˆ
        BD->>+Ent: ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ
        FD->>Ent: PRãƒ¬ãƒ“ãƒ¥ãƒ¼
        deactivate Ent
    end

    rect rgb(255, 248, 240)
        Note over Ent,ORM: è‡ªå‹•ç”Ÿæˆ
        par Generation Phase
            Ent-->>DB: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            Ent-->>OA: OpenAPI ç”Ÿæˆ
            OA-->>CL: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
            OA-->>SW: Swagger ç”Ÿæˆ
            Ent-->>ORM: ORM ç”Ÿæˆ
        end
    end

    rect rgb(240, 255, 240)
        Note over FD,BA: å®Ÿè£…
        par Development Phase
            FD->>FA: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
            FD->>SW: API ä»•æ§˜å‚ç…§
            BD->>BA: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
        end
        FA->>CL: ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        BA->>ORM: ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    end
```

## èª²é¡Œã¨è§£æ±ºç­–

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã‚’é€²ã‚ã‚‹ä¸­ã§ã€é–‹ç™ºåŠ¹ç‡ã¨ãƒ†ã‚¹ãƒˆã®ä¿¡é ¼æ€§ã«é–¢ã™ã‚‹ 2 ã¤ã®èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

### èª²é¡Œ 1. å¤–éƒ¨ API ä¾å­˜ãƒ†ã‚¹ãƒˆã«ãŠã‘ã‚‹ä¿¡é ¼æ€§å‘ä¸Š

####  èª²é¡Œ

- 1ã¤ç›®ã¯ã€å¤–éƒ¨ API ã«ä¾å­˜ã—ãŸãƒ†ã‚¹ãƒˆã®è„†å¼±æ€§ã§ã™ã€‚ä¸€éƒ¨ã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãŒå¤–éƒ¨ API ã®å‘¼ã³å‡ºã—ã‚’å¿…è¦ã¨ã—ã¦ã„ã¾ã™ã€‚å¤–éƒ¨ API ã®äºˆæœŸã›ã¬åœæ­¢ã‚„å¤‰æ›´ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šã«ãªã‚‹ãƒªã‚¹ã‚¯ã‚’æŠ±ãˆã¦ã„ã¾ã—ãŸã€‚

#### è§£æ±ºç­–

- ç§ãŸã¡ã¯ WireMock Standalone ( Running in Docker ) [^3] ã‚’æ´»ç”¨ã—ã¾ã—ãŸã€‚Dev Containers ã§ã€WireMock ã‚’ Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦èµ·å‹•ã™ã‚‹æ§‹æˆã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚
- ã“ã‚Œã«ã‚ˆã‚Šã€`mappings` ã«ã‚ã‚‹ å¤–éƒ¨ API ( `external-api.json` ) ã¯ã€ä¸€å®šã®å‹•ä½œã‚’ä¿è¨¼ã•ã‚Œã¾ã™ã€‚

```bash
.
â””â”€â”€ .devcontainer
    â”œâ”€â”€ devcontainer.env
    â”œâ”€â”€ devcontainer.json
    â”œâ”€â”€ docker-compose.yml
    â”œâ”€â”€ Dockerfile
    â””â”€â”€ wiremock
        â”œâ”€â”€ __files
        â”‚   â””â”€â”€ user.json
        â”œâ”€â”€ mappings
        â”‚   â”œâ”€â”€ external-api.json    # å¤–éƒ¨ API
        â”‚   â””â”€â”€ any.json
        â””â”€â”€ README.md
```

```yml:docker-compose.yml
  wiremock:
    image: wiremock/wiremock:3.9.1
    volumes:
      - ./wiremock/__files:/home/wiremock/__files
      - ./wiremock/mappings:/home/wiremock/mappings
    entrypoint:
      [
        '/docker-entrypoint.sh',
        '--global-response-templating',
        '--disable-gzip',
        '--verbose',
      ]
```

### èª²é¡Œ 2. ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã«ãŠã‘ã‚‹ãƒ¢ãƒƒã‚¯å¿…è¦æ€§

####  èª²é¡Œ

- 2ã¤ç›®ã®èª²é¡Œã¯ã€ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã«é–¢ã™ã‚‹ã‚‚ã®ã§ã—ãŸã€‚
- ç§ãŸã¡ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä¸¦è¡Œã—ã¦é–‹ç™ºã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚Backend API ã®å®Ÿè£…ãŒå®Œäº†ã™ã‚‹ã¾ã§ã®é–“ã€é©åˆ‡ãªãƒ¢ãƒƒã‚¯ãŒå¿…é ˆã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚é–‹ç™ºãƒ•ãƒ­ãƒ¼ã«ãŠã„ã¦ã€ã“ã®èª²é¡Œã«å¯¾ã™ã‚‹åŠ¹ç‡çš„ãªè§£æ±ºç­–ãŒå¿…è¦ã§ã—ãŸã€‚

#### è§£æ±ºç­–

- å¤–éƒ¨ API ã®å¯¾ç­–ã¨åŒæ§˜ã« Mock ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
- ç‰¹ã«é‡è¦ãªç‚¹ã¯ã€WireMock ã‚’ Proxy ã¨ã—ã¦ä½¿ç”¨ã—ãŸã“ã¨ã§ã™ã€‚WireMock ã«å®šç¾©ã•ã‚Œã¦ã„ãªã„ Requests ã¯å®Ÿéš›ã® Backend API Server ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚API ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸå¾Œã€Mock ã®å®šç¾©ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€å®Ÿ API ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚

> Proxying
> 
> WireMock has the ability to selectively proxy requests through to other hosts. This supports a proxy/intercept setup where requests are by default proxied to another (possibly real, live) service, but where specific stubs are configured these are returned in place of the remote serviceâ€™s response. Responses that the live service canâ€™t be forced to generate on demand can thus be injected for testing. Proxying also supports record and playback.ã€€[^4]

```json:any.json
{
  "priority": 99999,
  "request": {
    "urlPattern": "/.*"
  },
  "response": {
    "proxyBaseUrl": "http://localhost:3000"
  }
}
```

- ã¾ãŸã€ã“ã®æ§‹æˆã¯é–‹ç™ºç’°å¢ƒã¨ QA ç’°å¢ƒã§çµ±ä¸€ã—ã¾ã—ãŸã€‚QA ç’°å¢ƒã§ã¯ AWS ECS ä¸Šã« Mock ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚Endpoint ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ã§ã€ä¸€è²«ã—ãŸé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```json
    "containerDefinitions": [
        {
            "name": "wiremock",
            "image": "wiremock/wiremock:3.9.1",
            "cpu": 0,
            "portMappings": [
                {
                    "containerPort": 8080,
                    "hostPort": 8080,
                    "protocol": "tcp"
                }
            ],
            "essential": true,
            "mountPoints": [],
            "volumesFrom": [],
            "readonlyRootFilesystem": true,
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-group": "hoge",
                    "awslogs-region": "ap-northeast-1",
                    "awslogs-stream-prefix": "wiremock"
                }
            },
            "systemControls": []
        }
    ],
```

- é–‹ç™ºè€…ãŒ Mock ã® Response ã‚’å®¹æ˜“ã«è­˜åˆ¥ã§ãã‚‹ã‚ˆã†ã€Response ã®å†…å®¹ã«æ˜ç¤ºçš„ãª Marker ã‚’å«ã‚ã¾ã—ãŸã€‚

## é–‹ç™ºãƒ•ãƒ­ãƒ¼

1. é–‹ç™ºãƒãƒ¼ãƒ ã§ REST API ã® Schema ã‚’æ±ºå®š
1. Response ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„
1. æº–å‚™ã—ãŸ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ WireMock ã®è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
1. WireMock ã‚’ Reset `curl -X POST http://localhost:8080/__admin/mappings/reset`
1. æ–°ã—ã„ Mock ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹

## Summary

- WireMock ã®æ´»ç”¨ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã®å®‰å®šæ€§ãŒå‘ä¸Šã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸¦è¡Œé–‹ç™ºãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã—ãŸã€‚
- å¤–éƒ¨ API ã¸ã®ä¾å­˜åº¦ã‚’ä¸‹ã’ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šä¿¡é ¼æ€§ã®é«˜ã„é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

---

è¨˜äº‹ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ã„ãŸã ã„æ–¹ã¯ã„ã„ã­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ğŸ‘‹


[^1]: 2024å¹´7æœˆ1æ—¥ã€Chatworkæ ªå¼ä¼šç¤¾ã¯æ ªå¼ä¼šç¤¾kubellã¸ã¨ç¤¾åå¤‰æ›´ã—ã¾ã—ãŸã€‚

[^2]: https://wiremock.org/docs/

[^3]: https://wiremock.org/docs/standalone/docker/

[^4]: https://wiremock.org/docs/proxying/
