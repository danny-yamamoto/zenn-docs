---
title: "Mocking in Schema-Driven Development"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["mock", "nextjs", "nestjs", "devcontainers", "rest"]
published: false
---

kubell Advent Calendar 2024 の投稿です。 [^4]

https://qiita.com/advent-calendar/2024/kubell

この投稿では、Mocking を用いた Schema 駆動開発について書きます。

## tl;dr
- 外部 API への依存とスキーマ駆動開発における課題を解決するため、WireMock を導入
- Dev Containers と Docker 環境に統合
- 開発 / QA 環境で一貫した Mocking
- Proxy モードの活用により、実 API とモックの柔軟な切り替え

## 前提

### BPaaS サービスとは

- チャット経由で会計、労務、総務など様々なバックオフィス業務をアウトソースできる「Chatwork アシスタント」などのサービスです。
- 私たちは現在バックオフィス業務管理システムの構築を進めています。

https://assistant.chatwork.com/?adcode=orgic_platf_cwassistant_gm-om_corporate&utm_source=gm-om&utm_medium=corporate&utm_campaign=cwassistant&utm_term=non&utm_content=cid25

### スキルスタック

- 私たちの共通のスキルスタックは TypeScript です。Full-Satck TypeScript がチームの方向性として合致していました。
- Amplify は AWS CDK でインフラを構築でき、TypeScript との親和性が高いと思います。
    - 私自身の経験としても、CDK for Terraform (CDKTF) [^4] を使用して構築した経験があり、前職での経験が Amplify に対応しやすいものとなっていました。

## 課題

プロジェクトを進める中で、開発効率とテストの信頼性に関する 2 つの重要な課題が浮かび上がりました。

### 外部API依存テストにおける信頼性向上

1 つ目は、外部APIに依存したテストの脆弱性です。
一部の機能テストが外部APIの呼び出しを必要としており、API の予期せぬ停止や変更によってテストが不安定になるリスクを抱えていました。

### スキーマ駆動開発におけるモック必要性

2 つ目の課題は、スキーマ駆動開発に関するものでした。
フロントエンドとバックエンドを並行して開発を進める必要があったため、APIの実装が完了するまでの間、適切なモックが必須となっていました。
既存の開発フローでは、これらの課題に対する効率的な解決策が必要でした。

## 解決策
これらの課題を解決するため、私たちは WireMock の導入を決定しました。私自身の前職での WireMock 使用経験から、現在の課題に最適なツールだと判断しました。

Dev Containers を使用している開発環境において、WireMock を Docker コンテナとして起動する構成を採用しました。特に重要な点は、WireMock をプロキシとして使用したことです。WireMock に定義されていないリクエストは実際の API サーバーで処理される仕組みを実現し、この構成は開発環境と QA 環境で統一しました。QA 環境では AWS ECS 上に Mock クラスターを構築することで、一貫した開発・テスト環境を実現しています。

開発者がモックレスポンスを容易に識別できるよう、レスポンスの内容に明示的なマーカーを含めました。

### 開発フロー

1. 開発チームでスキーマを決定
1. JSONレスポンスを用意
1. 準備した JSON ファイルを WireMock の設定ディレクトリに配置
1. WireMock を Reset
1. 新しいモックが利用可能になる

### まとめ
WireMock の導入により、テストの安定性が向上し、フロントエンドとバックエンドの並行開発がスムーズになりました。
外部 API への依存度を下げることで、より信頼性の高い開発・テストサイクルを実現することができました。

---

記事は以上です。

この投稿をみていただい方はいいねをお願いします。

それでは次回のアドカレでお会いしましょう👋
