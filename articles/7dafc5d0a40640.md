---
title: "Load testing I am working on"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["k6", "playwright", "typescript"]
published: true
---

è² è·è©¦é¨“ã«ã¤ã„ã¦ã€‚

ç¾è·ã®é–‹ç™ºã®ãƒ­ãƒ¼ãƒ³ãƒã«å‘ã‘ãŸä½œæ¥­ãŒæœ¬æ ¼åŒ–ã—ã¦ã„ã‚‹ã€‚

Production ã®æ§‹æˆã®æ±ºå®šã‚„ã‚³ã‚¹ãƒˆã®è©¦ç®—ã€è„†å¼±æ€§è©¦é¨“ãªã©ã‚’é€²ã‚ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã€‚

è² è·è©¦é¨“ã¯å®Ÿéš›ã®ç’°å¢ƒã«è¿‘ã„çŠ¶æ…‹ã§è¡Œã„ãŸã„ã€‚ã“ã‚Œã¾ã§ã®çµŒé¨“ã‚’è¸ã¾ãˆã€‚

## tl;dr

- har-to-k6 [^1] ã¯ Playwright ã®ãƒ†ã‚¹ãƒˆ ã‚·ãƒŠãƒªã‚ªã‚’å†åˆ©ç”¨ã§ãã‚‹ã€‚
- k6 [^2] ã§å®Ÿè£…ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’å‰Šæ¸›ã§ãã‚‹ã€‚

```mermaid
flowchart LR
    playwright[Playwright] -->|Record a HAR file| har[HAR]
    har -->|Genearte| js[JavaScript]
    js --> k6
    k6 -->|Request| app["Web App"]
```

## HAR ã®ç”Ÿæˆ

- har ( HTTP Archiveãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ) [^3] ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€Context ã‚’è¨­å®šã€‚
- `context` ã‚’ Close ã™ã‚‹ã¨ã€har ãŒ `path` ã«ä½œæˆã•ã‚Œã‚‹ã€‚

```typescript
    const browser = await chromium.launch(); // Or 'chromium' or 'webkit'.
    const context = await browser.newContext({
      recordHar: {
        content: 'embed',
        mode: 'full',
        path: 'dist/requests.har',
      },
    });

    // ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

    // Close
    await context.close();
```

## k6 ç”¨ JavaScript ã®ç”Ÿæˆ

- har ã‚’å…ƒã« k6 ç”¨ã® JavaScript ã‚’ç”Ÿæˆã€‚

```bash
root âœ /workspaces/test-project/load-testing (main) $ npx har-to-k6 ../hoge/dist/requests.har -o test.js
info: Converting '../hoge/dist/requests.har'
info: Wrote k6 script to 'test.js'
root âœ /workspaces/test-project/load-testing (main) $ 
```

## å®Ÿè¡Œ

- k6 ã®é€šå¸¸ã®ã‚³ãƒãƒ³ãƒ‰ã¨åŒã˜ã€‚

```bash
root âœ /workspaces/test-project/load-testing (main) $ k6 run --vus 10 --duration 10s test.js 

          /\      |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/   
     /\  /  \     |  |/  /   /  /    
    /  \/    \    |     (   /   â€¾â€¾\  
   /          \   |  |\  \ |  (â€¾)  | 
  / __________ \  |__| \__\ \_____/ .io

     execution: local
        script: test.js
        output: -

     scenarios: (100.00%) 1 scenario, 10 max VUs, 40s max duration (incl. graceful stop):
              * default: 10 looping VUs for 10s (gracefulStop: 30s)

     data_received..................: 16 MB  394 kB/s
     data_sent......................: 294 kB 7.3 kB/s
     group_duration.................: avg=8.36s    min=8.2s    med=8.3s    max=8.63s    p(90)=8.62s    p(95)=8.62s   
     http_req_blocked...............: avg=4.9ms    min=83ns    med=334ns   max=247.93ms p(90)=1.08Âµs   p(95)=1.58Âµs  
     http_req_connecting............: avg=494.53Âµs min=0s      med=0s      max=26.69ms  p(90)=0s       p(95)=0s      
     http_req_duration..............: avg=114.48ms min=13.12ms med=33.23ms max=4.53s    p(90)=149.8ms  p(95)=182.3ms 
       { expected_response:true }...: avg=105.52ms min=13.12ms med=30.01ms max=4.53s    p(90)=138.03ms p(95)=180.32ms
     http_req_failed................: 39.29% âœ“ 492       âœ— 760 
     http_req_receiving.............: avg=4.64ms   min=6.83Âµs  med=1.06ms  max=157.88ms p(90)=8.09ms   p(95)=10.31ms 
     http_req_sending...............: avg=91.08Âµs  min=13.25Âµs med=58.68Âµs max=3.82ms   p(90)=165.77Âµs p(95)=231.4Âµs 
     http_req_tls_handshaking.......: avg=1.9ms    min=0s      med=0s      max=168.4ms  p(90)=0s       p(95)=0s      
     http_req_waiting...............: avg=109.74ms min=12.78ms med=29.25ms max=4.53s    p(90)=108.1ms  p(95)=180.7ms 
     http_reqs......................: 1252   31.300289/s
     iteration_duration.............: avg=9.36s    min=9.2s    med=9.3s    max=9.63s    p(90)=9.63s    p(95)=9.63s   
     iterations.....................: 10     0.250002/s
     vus............................: 10     min=10      max=10
     vus_max........................: 10     min=10      max=10


running (40.0s), 00/10 VUs, 10 complete and 10 interrupted iterations
default âœ“ [======================================] 10 VUs  10s
root âœ /workspaces/test-project/load-testing (main) 
```

## Conclusion

æœ€è¿‘ã¯ã€TypeScript ä»¥å¤–ã‚’è§¦ã‚‹æ©Ÿä¼šãŒæ¸›ã£ãŸã€‚

å€‹äººçš„ã«å–ã‚Šçµ„ã‚ã‚‹ã‚‚ã®ãŒãªã„ã‹è€ƒãˆã¦ã¿ã‚ˆã†ã¨æ€ã†ã€‚

æ¥­å‹™ã§å–ã‚Šçµ„ã‚€ã®ãŒä¸€ç•ªè‰¯ã„ã¨æ€ã†ãŒã€æ•£ã‚‰ã‹ã—ã¦è¿·æƒ‘ã‚’ã‹ã‘ã‚‹ã®ã¯è‰¯ããªã„ã€‚

[^1]: https://github.com/grafana/har-to-k6
[^2]: https://k6.io/
[^3]: https://ja.wikipedia.org/wiki/HAR_(%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88)
