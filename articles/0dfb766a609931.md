---
title: "Deploy Amplify Gen 2 with npm workspaces"
emoji: "ğŸ’¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["workspaces", "amplify", "typescript", "ecs"]
published: true
---
é›¨ã® Tokyo
![Alt text](/images/0dfb766a609931-a.jpg)

Amplify Gen 2 ( Amplify ) ã® deploy ã«ã¤ã„ã¦ã€‚

ã“ã®æ–‡ç« ã‚’æ›¸ãã«ã‚ãŸã‚Šå‰æã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
- Amplify ã§ã‚ã‚‹ã€‚
- Monorepo ã§ã‚ã‚‹ã€‚
- `npm workspaces` ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã€‚
- Backend ã¯ Amazon ECS ã§ã‚ã‚‹ã€‚

## tl;dr
- `npm-scripts` ã§ `npx ampx pipeline-deploy` ã‚’å®Ÿè¡Œã§ãã‚‹ã€‚`-w` option ã‚’æŒ‡å®šã™ã‚‹ã€‚

## Case1: `cd` ã‚³ãƒãƒ³ãƒ‰ã§å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é·ç§»ã—å®Ÿè¡Œã™ã‚‹
- FAILED
- `package-lock.json` ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€‚
```bash: CodeBuild
[Container] 2024/06/26 09:13:10.885476 Running command npx ampx pipeline-deploy --branch $BRANCH_NAME --app-id $AMPLIFY_APP_ID --debug
npm ERR! could not determine executable to run

npm ERR! A complete log of this run can be found in: /root/.npm/_logs/2024-06-26T09_13_11_097Z-debug-0.log

[Container] 2024/06/26 09:13:12.185043 Command did not exit successfully npx ampx pipeline-deploy --branch $BRANCH_NAME --app-id $AMPLIFY_APP_ID --debug exit status 1
[Container] 2024/06/26 09:13:12.190205 Phase complete: BUILD State: FAILED
[Container] 2024/06/26 09:13:12.190234 Phase context status code: COMMAND_EXECUTION_ERROR Message: Error while executing command: npx ampx pipeline-deploy --branch $BRANCH_NAME --app-id $AMPLIFY_APP_ID --debug. Reason: exit status 1
[Container] 2024/06/26 09:13:12.229527 Entering phase POST_BUILD
```

## Case2: `npm-scripts` ã§å®Ÿè¡Œã™ã‚‹
- SUCCEEDED
- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã„ãŸã ã„ãŸåŒåƒšã«æ„Ÿè¬ã€‚
```bash: CodeBuild
[Container] 2024/06/27 04:19:45.254696 Running command npm run amplify:deploy -w api

> api@0.0.1 amplify:deploy
> npx ampx pipeline-deploy --branch $BRANCH_NAME --app-id $AMPLIFY_APP_ID --debug true

[DEBUG] 2024-06-27T04:19:56.991Z: Bundling asset amplify-yyyy-BPD168-branch-xxxx/AmplifyBranchLinker/CustomResourceLambda/Code/Stage...

[DEBUG] 2024-06-27T04:19:57.571Z: 
  ...xxxxx/index.js  1002.4kb

âš¡ Done in 143ms

[DEBUG] 2024-06-27T04:19:58.125Z: 


[DEBUG] 2024-06-27T04:19:58.762Z: error TS5057: Cannot find a tsconfig.json file at the specified directory: 'amplify'.

[DEBUG] 2024-06-27T04:19:59.775Z: 
âœ¨  Synthesis time: 0.03s



âœ¨  Synthesis time: 0.03s
```

```json: api/package.json
{
  "name": "api",
  "version": "0.0.1",
  "description": "",
  "private": true,
  "scripts": {
    "amplify:deploy": "npx ampx pipeline-deploy --branch $BRANCH_NAME --app-id $AMPLIFY_APP_ID --debug true"
  },
  "dependencies": {
  },
  "devDependencies": {
  }
}
```

```yml: buildspec.yml
version: 0.2

phases:
  build:
    commands:
      - echo Build started on `date`
      - echo set up the build-spec when using CodeBuild...
      - export CI=1
      - npm ci
      - npm run amplify:deploy -w api
```

## Conclusion
ã‚„ã‚ŠãŸã„ã“ã¨ã‚’ã‚„ã‚Œã¦ã„ã‚‹ã‹ã€‚

https://x.com/KenTana2020/status/1803714681078710664

ã‚ãŸã—ã¯ã€ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã‚„ã‚Œã¦ã„ã‚‹ãŒã€è‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ã¨æ™‚é–“ãŒè¶³ã‚Šãªã„ã€‚
