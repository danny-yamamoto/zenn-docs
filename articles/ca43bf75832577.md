---
title: "The spiciness of Amplify Gen 2: CloudFormation"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["amplify", "cloudformation", "cdk"]
published: false
---
Amplify Gen 2 ( Amplify ) ã«ã¤ã„ã¦ã€‚

ã“ã“æ•°æ—¥æ‚©ã¾ã•ã‚Œã¦ããŸã“ã¨ã«ã¤ã„ã¦è¨˜è¼‰ã™ã‚‹ã€‚

## tl;dr
- 1 ã¤ã®æ–¹æ³•ã§è§£æ±ºã§ããšã€ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¦‹ãªãŒã‚‰ã€æ¬¡ã®æ–¹æ³•ã‚’æ¢ã™ã¨è¨€ã†æ„Ÿã˜ã§è§£æ±ºã—ãŸã€‚
- Ampify ã¯æœ€è¿‘ GA ã•ã‚ŒãŸã°ã‹ã‚Šã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã€æœªçŸ¥ã®éšœå®³ãŒã‚ã‚‹ã“ã¨ã¯æƒ³å®šã•ã‚Œã¦ã„ãŸã€‚
- ã‚µãƒãƒ¼ãƒˆã‚‚æœ‰åŠ¹ãªå›ç­”ã‚’æŒã¡åˆã‚ã›ã¦ãŠã‚‰ãšã€èª°ã«é ¼ã‚‹ã‚ã‘ã§ã‚‚ãªãã€è‡ªåˆ†ã§ã©ã†ã«ã‹ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ãŸã‚ã€éå¸¸ã«è¾›ã„ã€‚

## çªç„¶ deploy ã§ããªããªã‚‹
- äº‹è±¡
    - Amplify Console ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’æ–°ã—ãä½œæˆã—ãŸã€‚`backend.ts` ã®å¤‰æ›´ã¯ãªã„ã€‚
    - `npx ampx pipeline-deploy` ã®å®Ÿè¡ŒãŒå¤±æ•—ã€‚
    - ã‚¢ãƒ—ãƒªã®å†ä½œæˆã‚„ CodeBuild ã®å†è¨­å®šã§ã‚‚åŠ¹æœãªã—ã€‚
- åŸå› 
    - ä¸æ˜ã€‚
- å¯¾å‡¦æ–¹æ³•
    1. CloudFormation ã‚¹ã‚¿ãƒƒã‚¯ã® `CDKToolkit` ã‚’å‰Šé™¤ã€‚ [^2]
    1. S3 ã‹ã‚‰ `cdk-hnb659fds-assets-MY_ACCOUNT_ID-MY_REGION` ã‚’å‰Šé™¤ã€‚ [^2]
    1. ECR ã‹ã‚‰ `cdk-hnb659fds-container-assets-MY_ACCOUNT_ID-MY_REGION` ã‚’å‰Šé™¤ã€‚
    1. CloudShell ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ `CDKToolkit` ã‚’æ‰‹å‹•ã§æ›´æ–°ã€‚ [^3] [^1]

```bash: CodeBuild
[DEBUG] 2024-07-03T02:55:17.599Z: CloudFormationDeploymentError: The CloudFormation deployment has failed.
    at CdkErrorMapper.getAmplifyError (file:///codebuild/output/src1576062997/src/github.com/myorg/sample-app/node_modules/@aws-amplify/backend-deployer/lib/cdk_error_mapper.js:39:19)
    at CDKDeployer.tryInvokeCdk (file:///codebuild/output/src1576062997/src/github.com/myorg/sample-app/node_modules/@aws-amplify/backend-deployer/lib/cdk_deployer.js:166:39)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async CDKDeployer.deploy (file:///codebuild/output/src1576062997/src/github.com/myorg/sample-app/node_modules/@aws-amplify/backend-deployer/lib/cdk_deployer.js:63:30)
    at async Object.handler (file:///codebuild/output/src1576062997/src/github.com/myorg/sample-app/node_modules/@aws-amplify/backend-cli/lib/commands/pipeline-deploy/pipeline_deploy_command.js:41:9)
[DEBUG] 2024-07-03T02:55:17.599Z: Error: âŒ Deployment failed: Error: Failed to publish asset c5839853d1235553bec66df2f4f850090e151c312cacd1c076d2ead4371423f7:current_account-current_region
```

```bash: CodeBuild
amplify-zzzzzzzz-HOGE423-branch-xxxxxxxx: creating CloudFormation changeset...
[DEBUG] 2024-07-03T23:47:03.910Z: 
 âŒ  amplify-zzzzzzzz-HOGE423-branch-xxxxxxxx failed: Error [ValidationError]: Stack:arn:aws:cloudformation:ap-northeast-1:999999999999:stack/amplify-zzzzzzzz-HOGE423-branch-xxxxxxxx/e94ff1f0-398c-11ef-888e-0683abde6eb1 is in DELETE_FAILED state and can not be updated.
    at Request.extractError (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:46692)
    at Request.callListeners (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:91600)
    at Request.emit (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:91048)
    at Request.emit (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:199651)
    at Request.transition (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:193203)
    at AcceptorStateMachine.runTo (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:158075)
    at /codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:158405
    at Request.<anonymous> (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:193495)
    at Request.<anonymous> (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:199726)
    at Request.callListeners (/codebuild/output/src519137994/src/github.com/myorg/sample-app/node_modules/aws-cdk/lib/index.js:401:91768) {
  code: 'ValidationError',
  time: 2024-07-03T23:47:03.907Z,
  requestId: '0d381bf8-0c69-4080-a626-e5f278c4c92b',
  statusCode: 400,
  retryable: false,
  retryDelay: 425.126946062091
}
```

## Conclusion
ç¾è·ã®è©¦ç”¨æœŸé–“ãŒçµ‚äº†ã—ãŸã€‚

MVV ã¯éå¸¸ã«å…±æ„Ÿã™ã‚‹éƒ¨åˆ†ã§ã‚ã‚Šã€VALUE ã¯è‡ªåˆ†ãŒä¿¡æ¡ã¨ã—ã¦ã„ã‚‹ã“ã¨ã¨é‡ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚„ã‚Šã«ãã•ã¯ãªã„ã€‚

ä¸€æ–¹ã§ã€ä»–ã®ä¼šç¤¾ã¨åŒæ§˜ã«ã€ä¸€éƒ¨ã§å‡ºç¤¾ã‚’å‰æã¨ã—ãŸè¨­è¨ˆãŒå§‹ã¾ã£ã¦ãŠã‚Šã€ç–‘å•ç‚¹ãŒã‚ã‚‹ã€‚

éåŒæœŸã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã™ã‚‹ä¼šç¤¾ã‹ã‚‰ BPaaS ã®ä¼šç¤¾ã¸ã¨å¤‰è²Œã—ã¦ã„ã‚‹ã“ã¨ãŒè¦å› ã ã¨æ€ã†ã€‚

ã—ã‹ã—ã€å€‹äººçš„ã«ã¯é€šå‹¤æ™‚é–“ã«å¯¾ã™ã‚‹æŠµæŠ—æ„ŸãŒå¤§ãã„ã€‚

[^1]: https://docs.amplify.aws/react/build-a-backend/troubleshooting/stack-cdktoolkit-already-exists/
[^2]: https://qiita.com/wagasa2/items/882183e0360b76d79b5e
[^3]: https://zenn.dev/shimo_s3/articles/fd2330869236fe
