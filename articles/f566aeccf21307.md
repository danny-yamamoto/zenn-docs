---
title: "Revisiting driftctl"
emoji: "üèéÔ∏è"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["terraform", "googlecloud", "driftctl", "finops", "iac"]
published: true
---

driftctl[^1] „Å´„Å§„ÅÑ„Å¶„ÄÇ

![output](/images/f566aeccf21307-a.png)

https://docs.driftctl.com/0.40.0

ÂÄã‰∫∫ÁöÑ„Å´„ÅØ Infrastructure as Code (IaC) „ÇíÂèñ„ÇäÂÖ•„Çå„Çã„ÅÆ„ÅØÊØîËºÉÁöÑÁ∞°Âçò„Å†„Å®ÊÄù„ÅÜ„ÄÇ

Terraform „Å´Ë§áÈõë„Å™ÊñáÊ≥ï„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Åó„ÄÅTerraform „ÅÆÊú¨„ÇÑË®ò‰∫ã„ÅØÂ§ßÈáè„Å´„ÅÇ„Çã„ÄÇ

‰∏ÄÊñπ„ÄÅIaC „ÇíÁ∂≠ÊåÅ„Åô„Çã„Åì„Å®„ÅØÁõ∏Âøú„Å´Èõ£„Åó„ÅÑ„Å®ÊÄù„ÅÜ„ÄÇ„Å™„Åú„Åã„ÄÇ

console „ÅåÂ≠òÂú®„Åô„Çã„Åü„ÇÅ„ÄÅconsole „ÅßÂ§âÊõ¥„Åó„ÄÅÁä∂ÊÖã„ÅÆ‰πñÈõ¢„ÅåÁîü„Åæ„Çå„Çã„Åã„Çâ„ÄÇ

Êîπ„ÇÅ„Å¶ driftctl[^1] „Å´„Å§„ÅÑ„Å¶Â∞éÂÖ•„ÇíÊ§úË®é„Åô„Çã„ÄÇ

## tl;dr
- ÁèæÂú®„ÅØ Google Cloud „Åß„ÇÇ‰Ωø„Åà„Çã„ÄÇÂΩìÂàù„ÅØ AWS „ÅÆ„Åø„Å†„Å£„Åü„ÄÇ
- ÊÑèÂõ≥„Åó„Å™„ÅÑ IAM „ÅÆ‰ªò‰∏é„Å™„Å©„ÇíÁõ£Êüª„Åß„Åç„Çã„ÄÇCI (Continuous Integration) „ÅÆ step „Å®„Åó„Å¶ÁµÑ„ÅøËæº„ÇÅ„Åù„ÅÜ„ÄÇ
- `.driftignore`[^4] „ÅÆÁÆ°ÁêÜ„ÅåÈáçË¶Å„ÄÇ

## About driftctl
Snyk „ÅÆ OSS„ÄÇ

> driftctl is CLI tool that measures infrastructure as code coverage, and tracks infrastructure drift.
> 
> driftctl „ÅØ„ÄÅ„Ç≥„Éº„Éâ„Éª„Ç´„Éê„É¨„ÉÉ„Ç∏„Å®„Åó„Å¶„Ç§„É≥„Éï„É©„Çπ„Éà„É©„ÇØ„ÉÅ„É£„ÇíÊ∏¨ÂÆö„Åó„ÄÅ„Ç§„É≥„Éï„É©„Çπ„Éà„É©„ÇØ„ÉÅ„É£„ÅÆ„Éâ„É™„Éï„Éà„ÇíËøΩË∑°„Åô„Çã CLI „ÉÑ„Éº„É´„Åß„ÅÇ„Çã„ÄÇ

## Getting stated
### IAM
driftctl „ÇíÂÆüË°å„Åô„ÇãÔºà„Åï„Åõ„ÇãÔºâ„Åü„ÇÅ„Å´„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆ role „ÅåÂøÖË¶Å„ÄÇ
- `roles/viewer` Èñ≤Ë¶ßËÄÖ
- `roles/serviceusage.serviceUsageAdmin` Service Usage ÁÆ°ÁêÜËÄÖ
or
- `roles/serviceusage.serviceUsageAdmin` Service Usage ÁÆ°ÁêÜËÄÖ
- `roles/cloudasset.viewer` „ÇØ„É©„Ç¶„Éâ „Ç¢„Çª„ÉÉ„ÉàÈñ≤Ë¶ßËÄÖ

### Installation[^2]
- Cloud Shell „Å´ install „Åô„Çã„ÄÇ
```bash
curl -L https://github.com/snyk/driftctl/releases/latest/download/driftctl_linux_amd64 -o driftctl
chmod +x driftctl
sudo mv driftctl /usr/local/bin/
```

### Usage[^3]
- scan ÂØæË±°„ÅÆ project „ÇíÊåáÂÆö„Åô„Çã„Åì„Å®„ÅåÈáçË¶Å„ÄÇ`CLOUDSDK_CORE_PROJECT`

```bash: command
CLOUDSDK_CORE_PROJECT=hoge\
  driftctl scan --to gcp+tf --from tfstate+gs://hoge-tfstate/env/dev/default.tfstate
```

:::details scan
```bash: log
gcp_iam_verifier@cloudshell:~ (hoge)$ CLOUDSDK_CORE_PROJECT=hoge\
  driftctl scan --to gcp+tf --from tfstate+gs://hoge-tfstate/env/dev/default.tfstate
Scanned states (1)      
Found resources not covered by IaC:
  google_compute_address:
    - projects/hoge/regions/asia-northeast2/addresses/nat-auto-ip-21669046-5-1704943320202150
        Address: xx.xx.xx.xx, Name: nat-auto-ip-21669046-5-1704943320202150
  google_compute_disk:
    - projects/hoge/zones/asia-northeast2-a/disks/gke-cluster-hoge-service-pool-0d194ef2-d6sk
        Name: gke-cluster-hoge-service-pool-0d194ef2-d6sk
  google_compute_firewall:
    - projects/hoge/global/firewalls/default-allow-icmp
    - projects/hoge/global/firewalls/default-allow-internal
    - projects/hoge/global/firewalls/default-allow-rdp
    - projects/hoge/global/firewalls/default-allow-ssh
    - projects/hoge/global/firewalls/gke-cluster-hoge-fdda8f5b-all
    - projects/hoge/global/firewalls/gke-cluster-hoge-fdda8f5b-exkubelet
    - projects/hoge/global/firewalls/gke-cluster-hoge-fdda8f5b-inkubelet
    - projects/hoge/global/firewalls/gke-cluster-hoge-fdda8f5b-master
    - projects/hoge/global/firewalls/gke-cluster-hoge-fdda8f5b-vms
    - projects/hoge/global/firewalls/k8s-7e03882898f0acc7-node-http-hc
    - projects/hoge/global/firewalls/k8s-fw-a551924e3cf67427db25e0a105f0fb7a
  google_compute_forwarding_rule:
    - projects/hoge/regions/asia-northeast2/forwardingRules/a551924e3cf67427db25e0a105f0fb7a
  google_compute_global_address:
    - projects/hoge/global/addresses/hoge-ip-range
        Address: 10.88.80.0, Name: hoge-ip-range
  google_compute_instance:
    - projects/hoge/zones/asia-northeast2-a/instances/gke-cluster-hoge-service-pool-0d194ef2-d6sk
  google_compute_instance_group:
    - projects/hoge/zones/asia-northeast2-a/instanceGroups/gke-cluster-hoge-process-pool-7ccd9538-grp
        Name: gke-cluster-hoge-process-pool-7ccd9538-grp
    - projects/hoge/zones/asia-northeast2-a/instanceGroups/gke-cluster-hoge-service-pool-0d194ef2-grp
        Name: gke-cluster-hoge-service-pool-0d194ef2-grp
    - projects/hoge/zones/asia-northeast2-a/instanceGroups/gke-cluster-hoge-service-pool-61ee2fe7-grp
        Name: gke-cluster-hoge-service-pool-61ee2fe7-grp
  google_compute_instance_group_manager:
    - projects/hoge/zones/asia-northeast2-a/instanceGroupManagers/gke-cluster-hoge-process-pool-7ccd9538-grp
        Name: gke-cluster-hoge-process-pool-7ccd9538-grp
    - projects/hoge/zones/asia-northeast2-a/instanceGroupManagers/gke-cluster-hoge-service-pool-0d194ef2-grp
        Name: gke-cluster-hoge-service-pool-0d194ef2-grp
    - projects/hoge/zones/asia-northeast2-a/instanceGroupManagers/gke-cluster-hoge-service-pool-61ee2fe7-grp
        Name: gke-cluster-hoge-service-pool-61ee2fe7-grp
  google_compute_network:
    - projects/hoge/global/networks/default
  google_compute_subnetwork:
    - projects/hoge/regions/africa-south1/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-east1/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-east2/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-northeast1/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-northeast2/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-northeast3/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-south1/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-south2/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-southeast1/subnetworks/default
        Name: default
    - projects/hoge/regions/asia-southeast2/subnetworks/default
        Name: default
    - projects/hoge/regions/australia-southeast1/subnetworks/default
        Name: default
    - projects/hoge/regions/australia-southeast2/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-central2/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-north1/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-southwest1/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west1/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west10/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west12/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west2/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west3/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west4/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west6/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west8/subnetworks/default
        Name: default
    - projects/hoge/regions/europe-west9/subnetworks/default
        Name: default
    - projects/hoge/regions/me-central1/subnetworks/default
        Name: default
    - projects/hoge/regions/me-central2/subnetworks/default
        Name: default
    - projects/hoge/regions/me-west1/subnetworks/default
        Name: default
    - projects/hoge/regions/northamerica-northeast1/subnetworks/default
        Name: default
    - projects/hoge/regions/northamerica-northeast2/subnetworks/default
        Name: default
    - projects/hoge/regions/southamerica-east1/subnetworks/default
        Name: default
    - projects/hoge/regions/southamerica-west1/subnetworks/default
        Name: default
    - projects/hoge/regions/us-central1/subnetworks/default
        Name: default
    - projects/hoge/regions/us-east1/subnetworks/default
        Name: default
    - projects/hoge/regions/us-east4/subnetworks/default
        Name: default
    - projects/hoge/regions/us-east5/subnetworks/default
        Name: default
    - projects/hoge/regions/us-east7/subnetworks/default
        Name: default
    - projects/hoge/regions/us-south1/subnetworks/default
        Name: default
    - projects/hoge/regions/us-west1/subnetworks/default
        Name: default
    - projects/hoge/regions/us-west2/subnetworks/default
        Name: default
    - projects/hoge/regions/us-west3/subnetworks/default
        Name: default
    - projects/hoge/regions/us-west4/subnetworks/default
        Name: default
    - projects/hoge/regions/us-west8/subnetworks/default
        Name: default
  google_project_iam_member:
    - hoge/roles/artifactregistry.reader/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/cloudasset.viewer/group:gcp-hoge-developers@example.jp
    - hoge/roles/cloudscheduler.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/cloudsql.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/cloudsql.client/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/compute.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/container.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/container.clusterAdmin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/iam.serviceAccountAdmin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/iam.serviceAccountCreator/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/iam.serviceAccountDeleter/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/iam.serviceAccountUser/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/owner/user:danny@example.jp
    - hoge/roles/pubsub.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/resourcemanager.projectIamAdmin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/run.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/secretmanager.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/serviceusage.serviceUsageAdmin/group:gcp-hoge-developers@example.jp
    - hoge/roles/serviceusage.serviceUsageAdmin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/storage.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
    - hoge/roles/viewer/group:gcp-hoge-developers@example.jp
    - hoge/roles/vpcaccess.admin/serviceAccount:terraform@hoge.iam.gserviceaccount.com
  google_sql_database_instance:
    - hoge
  google_storage_bucket:
    - hoge-tfstate
Found 106 resource(s)
 - 16% coverage
 - 17 resource(s) managed by Terraform
 - 89 resource(s) not managed by Terraform
 - 0 resource(s) found in a Terraform state but missing on the cloud provider
Scan duration: 4s
Provider version used to scan: . Use --tf-provider-version to use another version.
gcp_iam_verifier@cloudshell:~ (hoge)$ 
```
:::

## Practice
- Ë®±ÂÆπ„Åô„Çã„ÇÇ„ÅÆ„Çí `.driftignore`[^4] „Å´ÂÆöÁæ©„Åô„Çã„ÄÇ
- `.driftignore` „Å´Â≠òÂú®„Åó„Å™„ÅÑ service account/mail account „ÅÆ role „ÅåËøΩÂä†„Åï„Çå„ÅüÂ†¥Âêà coverage „Åå 100 „ÇíÂàá„Çã„ÄÇ„Åù„Çå„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„ÄÇ

```bash
# driftctl scan --driftignore /path/to/driftignore
CLOUDSDK_CORE_PROJECT=hoge\
  driftctl scan --to gcp+tf --from tfstate+gs://hoge-tfstate/env/dev/default.tfstate  --driftignore /home/gcp_iam_verifier/.driftignore
```

```bash:log
gcp_iam_verifier@cloudshell:~ (hoge)$ cat .driftignore
*
!google_project_iam_member
*serviceAccount:terraform@hoge.iam.gserviceaccount.com
*yamamoto_daisuke@example.jp
*gcp-hoge-developers@example.jp
gcp_iam_verifier@cloudshell:~ (hoge)$ CLOUDSDK_CORE_PROJECT=hoge  driftctl scan --to gcp+tf --from tfstate+gs://hoge-tfstate/env/dev/default.tfstate  --driftignore /home/gcp_iam_verifier/.driftignore
Scanned states (1)      
Found 14 resource(s)   
 - 100% coverage
Congrats! Your infrastructure is fully in sync.
Scan duration: 2s
Provider version used to scan: . Use --tf-provider-version to use another version.
gcp_iam_verifier@cloudshell:~ (hoge)$ 
```

[^1]: https://docs.driftctl.com/0.40.0
[^2]: https://docs.driftctl.com/0.40.0/installation
[^3]: https://docs.driftctl.com/0.40.0/providers/google/authentication
[^4]: https://docs.driftctl.com/next/usage/filtering/driftignore/
