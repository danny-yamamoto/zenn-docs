---
title: "API vulnerability scan I'm working on"
emoji: "ğŸ•µï¸â€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["zap", "duckdb", "security"]
published: true
---

Web App ã®è„†å¼±æ€§ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã€‚

å‰è·ã§ ZAP ã® Baseline Scan [^2] ã‚’æµã—ãŸã“ã¨ã¯ã‚ã‚‹ã€‚

ã—ã‹ã—ã€ZAP API [^1] ã«ã¤ã„ã¦è©³ã—ãå­¦ã¶ã“ã¨ã¯ãªã‹ã£ãŸã€‚ä»Šå›ã€æ”¹ã‚ã¦ ZAP API ã«ã¤ã„ã¦å­¦ã‚“ã ãŸã‚ã€è¦šãˆæ›¸ãã¨ã—ã¦æ®‹ã™ã€‚

## zaproxy ã‚’èµ·å‹•

- ä»Šå›ã¯ dind ã§èµ·å‹•ã—ã¦ã„ã‚‹ã€‚Network ã¯ãƒ›ã‚¹ãƒˆå´ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```bash
docker run --name zap -u zap -p 8090:8090 --network="host"  -i zaproxy/zap-stable zap.sh -daemon -port 8090 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.disablekey=true
```

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆ

- ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ URL ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨è¨€ã†ã€‚
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆã—ã€ãã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¯¾ã—ã¦ç‰¹å®šã® URL ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚ã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚¹ã‚­ãƒ£ãƒ³ãªã©ã«é©ç”¨ã™ã‚‹æº–å‚™ã‚’æ•´ãˆã‚‹ã€‚

```bash
export MY_CONTEXT=hoge
echo $MY_CONTEXT

curl -X GET "http://localhost:8090/JSON/context/action/newContext/?contextName=$MY_CONTEXT"
curl -X GET "http://localhost:8090/JSON/context/action/includeInContext/?contextName=$MY_CONTEXT&regex=http%3A%2F%2Flocalhost%3A3000%2F.*"
```

## ã‚¹ãƒ‘ã‚¤ãƒ€ãƒªãƒ³ã‚° (Spider)

- `http://localhost:3000/` ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•ã§ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã—ã€ãƒªãƒ³ã‚¯ã‚’è¾¿ã£ã¦æ¢ç´¢ã™ã‚‹ã€‚

```bash
curl -X GET "http://localhost:8090/JSON/spider/action/scan/?url=http://localhost:3000/&contextName=$MY_CONTEXT"
```

## ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ (Active Scan)

- `http://localhost:3000/` ä»¥ä¸‹ã®URLã«å¯¾ã—ã¦ã€è„†å¼±æ€§ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚

```bash
curl -X GET "http://localhost:8090/JSON/ascan/action/scan/?url=http://localhost:3000/&recurse=true&inScopeOnly=true&contextName=$MY_CONTEXT"
```

## ã‚¢ãƒ©ãƒ¼ãƒˆã®è¦ç´„ã‚’å–å¾—

- `http://localhost:3000/` ã«å¯¾ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚¢ãƒ©ãƒ¼ãƒˆã®è¦ç´„ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã®ãƒ¬ãƒ™ãƒ«ï¼ˆ `High` `Low` `Medium` `Informational`ï¼‰ãŒå«ã¾ã‚Œã‚‹ã€‚

```bash
curl -X GET "http://localhost:8090/JSON/core/view/alertsSummary/?baseurl=http://localhost:3000/"
```

## è©³ç´°ãªã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—

- `http://localhost:3000/` ã«é–¢é€£ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±ã‚’æœ€å¤§ N ä»¶å–å¾—ã€‚
- JSON ã‚’ DuckDB [^3] ãªã©ã§å‚ç…§ã™ã‚‹ã¨ã€å¿…è¦ãªã‚¢ãƒ©ãƒ¼ãƒˆ ãƒ¬ãƒ™ãƒ«ã”ã¨ã®èª¿æŸ»ãŒã§ãã‚‹ã€‚ä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ãŸã‚Šã€æ¡ä»¶ã§çµã£ãŸã‚Šã€‚

```bash
curl -X GET "http://localhost:8090/JSON/core/view/alerts/?baseurl=http://localhost:3000/&start=0&count=100" | jq > zap.json
```

## Quick Note

10æœˆã¯ã€ä¹…ã—ã¶ã‚Šã« Rust ã‚’ã‚„ã£ã¦ã¿ã‚‹äºˆå®šã€‚

https://gihyo.jp/book/2024/978-4-297-14413-5

ã—ã‹ã—ã€ä»Šã®ã¨ã“ã‚ã€è·å ´ã§ Rust ãŒå½¹ç«‹ã¤äºˆå®šã¯ç„¡ã„ã€‚

[^1]: https://www.zaproxy.org/docs/api/

[^2]: https://www.zaproxy.org/docs/docker/baseline-scan/

[^3]: https://duckdb.org/docs/
