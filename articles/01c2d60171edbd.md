---
title: "[WIP] BPaaS ãŒ AWS Amplify Gen 2 ã‚’é¸æŠã™ã‚‹ç†ç”±"
emoji: "ğŸ’¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript", "amplify", "aws", "nextjs", "nestjs"]
published: true
---

![thumbnail](/images/01c2d60171edbd-a.png)

kubell Advent Calendar 2024 ã®æŠ•ç¨¿ã§ã™ã€‚

:::message
2024å¹´7æœˆ1æ—¥ã€Chatworkæ ªå¼ä¼šç¤¾ã¯æ ªå¼ä¼šç¤¾kubellã¸ã¨ç¤¾åå¤‰æ›´ã—ã¾ã—ãŸã€‚
:::

https://qiita.com/advent-calendar/2024/kubell

ã“ã®æŠ•ç¨¿ã§ã¯ã€BPaaS ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã«ãŠã„ã¦ AWS Amplify Gen 2 (Amplify) ã‚’é¸æŠã—ãŸç†ç”±ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## tl;dr

- Amplify ã‚’é¸å®šã—ãŸç†ç”±ã¯ã€é–‹ç™ºåŠ¹ç‡ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰å‘ä¸Šã®ãŸã‚
- AWS ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ãƒã‚¤ãƒ†ã‚£ãƒ–çµ±åˆã§èªè¨¼ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šãŒç°¡å˜
- è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤æ©Ÿèƒ½ã«ã‚ˆã‚Šè¿…é€Ÿãªé–‹ç™ºã¨ãƒªãƒªãƒ¼ã‚¹ãŒå¯èƒ½
- æŸ”è»Ÿãªç’°å¢ƒç®¡ç†ã§ãƒãƒ¼ãƒ ã®è¦ä»¶ã«é©åˆ

## å‰æ

### BPaaS ã‚µãƒ¼ãƒ“ã‚¹ã¨ã¯

- ãƒãƒ£ãƒƒãƒˆçµŒç”±ã§ä¼šè¨ˆã€åŠ´å‹™ã€ç·å‹™ãªã©æ§˜ã€…ãªãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ã‚’ã‚¢ã‚¦ãƒˆã‚½ãƒ¼ã‚¹ã§ãã‚‹ã€ŒChatwork ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
- ç§ãŸã¡ã¯ç¾åœ¨ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚

https://assistant.chatwork.com/?adcode=orgic_platf_cwassistant_gm-om_corporate&utm_source=gm-om&utm_medium=corporate&utm_campaign=cwassistant&utm_term=non&utm_content=cid25

### ã‚¹ã‚­ãƒ«ã‚¹ã‚¿ãƒƒã‚¯

- ç§ãŸã¡ã®å…±é€šã®ã‚¹ã‚­ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã¯ TypeScript ã§ã™ã€‚Full-Satck TypeScript ãŒãƒãƒ¼ãƒ ã®æ–¹å‘æ€§ã¨ã—ã¦åˆè‡´ã—ã¦ã„ã¾ã—ãŸã€‚
- Amplify ã¯ AWS CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã§ãã€TypeScript ã¨ã®è¦ªå’Œæ€§ãŒé«˜ã„ã¨æ€ã„ã¾ã™ã€‚
    - ç§è‡ªèº«ã®çµŒé¨“ã¨ã—ã¦ã‚‚ã€CDK for Terraform (CDKTF) [^4] ã‚’ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã—ãŸçµŒé¨“ãŒã‚ã‚Šã€å‰è·ã§ã®çµŒé¨“ãŒ Amplify ã«å¯¾å¿œã—ã‚„ã™ã„ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚

### ãƒãƒ¼ãƒ çŠ¶æ³

ç§ãŸã¡ãŒãƒãƒ¼ãƒ ã‚’æ§‹ç¯‰ã—ãŸã®ã¯æœ€è¿‘ã§ã€Developer ã¯å¤šãã‚ã‚Šã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€åŠ¹ç‡çš„ã«é–‹ç™ºã‚’é€²ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

## Amplify ã‚’é¸å®šã—ãŸç†ç”±

### é–‹ç™ºåŠ¹ç‡ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã®å‘ä¸Š

å¸‚å ´å¿—å‘ã®ãƒãƒ¼ãƒ ã¨ã—ã¦ã€é–‹ç™ºåŠ¹ç‡ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã®å‘ä¸Šã¨ã„ã†æ˜ç¢ºãªç†ç”±ãŒã‚ã‚Šã¾ã™ã€‚Amplify ã¯ã€ç°¡å˜ã«å®‰å…¨ã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªã‚¢ãƒ—ãƒªã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ´»ç”¨

- AWS ã®å„ç¨®ã‚µãƒ¼ãƒ“ã‚¹ã€ç‰¹ã«èªè¨¼ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãªçµ±åˆãŒç‰¹å¾´ã§ã™ã€‚
- Amplify ãŒæŒã¤ã“ã®ç‰¹å¾´ã‚ˆã‚Šã€å¿…è¦ã«å¿œã˜ã¦ Amazon Cognito ãªã©ã® AWS ã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã€æŸ”è»Ÿãªã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆãŒå¯èƒ½ã§ã™ã€‚

https://docs.amplify.aws/vue/build-a-backend/auth/set-up-auth/

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯é¸å®š

- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® Frameowork ã¨ã—ã¦ NestJS ã‚’é¸å®šã—ã¾ã—ãŸã€‚

https://docs.nestjs.com/

- ã“ã®é¸æŠã«ã‚ˆã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã©ã¡ã‚‰ã‚‚é–‹ç™ºã™ã‚‹ã“ã¨ãŒã§ãã€ãƒ¡ãƒ³ãƒãƒ¼ã®ä½œæ¥­è² è·çŠ¶æ³ã«åˆã‚ã›ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ç§»å‹•ã—ãªãŒã‚‰é–‹ç™ºã§ãã¾ã™ã€‚
- ãƒªãƒã‚¸ãƒˆãƒªã¯ Monorepo ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ Nx [^2] ã‚„ Turborepo [^3] ã¯æ¤œè¨ã—ã¾ã—ãŸãŒã€2024å¹´5æœˆå½“æ™‚ Amplify ã® Framework æ¤œçŸ¥ã«èª¤ä½œå‹•ãŒã‚ã£ãŸãŸã‚ã€è¦‹é€ã‚Šã¾ã—ãŸã€‚
    - ãƒªãƒã‚¸ãƒˆãƒª ãƒ«ãƒ¼ãƒˆã® package.json ã® dependencies ã« `next` ãŒå«ã¾ã‚Œã‚‹å ´åˆã€å½“è©²ã‚¢ãƒ—ãƒªã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒ Next.js ã¨èªè­˜ã•ã‚Œã‚‹å‹•ä½œã¨ãªã£ã¦ã„ãŸã€‚
    ```bash
    [ERROR]: !!! CustomerError: Can't find required-server-files.json in build output directory
    ```

https://docs.npmjs.com/cli/v7/using-npm/workspaces

### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ç’°å¢ƒç®¡ç†ã®æŸ”è»Ÿæ€§

![alt text](/images/01c2d60171edbd-b.jpg)

- Amplify ã«ã¯ default ã§ GitHub ã¨é€£æºã—ã¦è‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†æ©Ÿèƒ½ãŒã‚ã‚Šã€é–‹ç™ºãƒãƒ¼ãƒ å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼ã‚’å††æ»‘ã«ã™ã‚‹å½¹å‰²ã‚’æœãŸã—ã¦ã„ã¾ã™ã€‚
- ç‰¹ã«ç§ãŸã¡ã®ã‚ˆã†ã«ç´ æ—©ã„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ ãƒªãƒªãƒ¼ã‚¹ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ ãƒãƒƒã‚¯ã‚µã‚¤ã‚¯ãƒ«ã‚’ç›®è²¡ã—ã¦ã„ã‚‹ãƒãƒ¼ãƒ ã«ã¨ã£ã¦ã€Amplify ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ©Ÿèƒ½ã¯éå¸¸ã«é­…åŠ›çš„ã ã¨æ€ã„ã¾ã™ã€‚
- Amplify Console ã®åˆ©ç”¨ã«ã‚ˆã‚Šã€ç•°ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’ç•°ãªã‚‹ç’°å¢ƒï¼ˆä¾‹ãˆã° Staging ã‚„ Productionï¼‰ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€ç’°å¢ƒã”ã¨ã®ãƒ†ã‚¹ãƒˆã‚„ç¢ºèªãŒã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œãˆã¾ã™ã€‚

## èª²é¡Œ

### Amplify Managed ã®åˆ¶ç´„

- Amplify Managed Frontend ã¯ CloudFrontã€Lambda ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®æ§‹æˆã¯ã€é–‹ç™ºè€…ã®ä½œæ¥­ã‚’çœåŠ›åŒ–ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ãŒã€ä¸€éƒ¨ã®åˆ¶ç´„ã‚‚ä¼´ã„ã¾ã™ã€‚
- ç‰¹ã«ã€Lambda ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ããªã„ã¨ã„ã†èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€Lambda ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ– ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ­ã‚°ã«ãƒˆãƒ¬ãƒ¼ã‚¹ ID ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒæœ›ã¾ã‚Œã¾ã™ãŒã€Amplify ã® Managed ç’°å¢ƒã§ã¯ç¾æ™‚ç‚¹ã§ã“ã®è¨­å®šãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚[^1] ã“ã®åˆ¶ç´„ã«ã‚ˆã‚Šã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã®åŠ¹ç‡ãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/aws-amplify/amplify-hosting/issues/3515

### `ampx` ã‚³ãƒãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼è§£æã®é›£ã—ã•

- `ampx` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ç™ºç”Ÿã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‹ã‚‰åŸå› ã‚’ç‰¹å®šã™ã‚‹ã®ã¯ãã®æ™‚ç‚¹ã§ã¯é›£ã—ã„ã¨æ„Ÿã˜ã‚‰ã‚Œã¾ã—ãŸã€‚
    - ä¾‹ãˆã°ã€ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ `current_account-current_region` ã¯ã€Amplify ãŒå†…éƒ¨çš„ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ CDK ã«ã¦ã€CDK ãŒå†…éƒ¨çš„ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚¢ã‚»ãƒƒãƒˆ ã® destinationId ã®å€¤ã¨ãªã‚Šã¾ã™ã€‚æˆåŠŸã™ã‚‹å ´åˆã«ã‚‚ `current_account-current_region` ã¯ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›çµæœã«å«ã¾ã‚Œã‚‹ã®ã§ã€ã“ã‚ŒãŒå½“è©²äº‹è±¡ã®è¦å› ã§ã¯ãªã„ã€‚
    ```bash
    The CloudFormation deployment has failed.
    Caused By: âŒ Deployment failed: Error: Failed to publish asset 7af0558dad8eb937cbd5c43b7fe6bec9b1f611815c892643b5099811a28c3480:current_account-current_region
    ```

- ä¸€æ–¹ `cdk diff` `cdk deploy` ã®è­¦å‘Šã‚„ StackTrace ã¯å¤šãã®æƒ…å ±ã‚’ä¸ãˆã¦ãã‚Œã¾ã™ã€‚`ampx` ã‚³ãƒãƒ³ãƒ‰ã¨æ¯”è¼ƒã—ã¦ã€‚

### Stateful ãªæ§‹æˆè¦ç´ ã®æ‰±ã„

```mermaid
flowchart TD
    subgraph aws["AWS Cloud"]
        subgraph amplify["Amplify Managed Frontend"]
            cloudfront["CloudFront
            (CDN)"]
            lambda["Lambda
            (Server-side Render)"]
        end
        subgraph account["AWS Account"]
            alb[ALB]
            ecs["ECS
            (API)"]
            rds[("RDS
            (Database)")]
        end
    end
    browser --> cloudfront
    cloudfront --> lambda
    lambda -->|Traffic in the AWS network| alb
    alb --> ecs
    ecs --> rds
    cicd["Amplify CI/CD"] -.->|npx ampx pipeline-deploy| amplify
    developer -.->|cdk deploy| account
```

- å½“åˆã¯ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã¨ã—ã¦ã€å…¨ã¦ã‚’ Amplify ã§å®šç¾©ã™ã‚‹ã¤ã‚‚ã‚Šã§ã—ãŸã€‚

https://github.com/danny-yamamoto/buttermilk-backend-app/blob/main/amplify/backend.ts

- ã—ã‹ã—ã€ Database ãªã©ã® Stateful ãªæ§‹æˆè¦ç´ ã¯å¤‰æ›´ãŒå¿…è¦ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé™ã‚‰ã‚Œã¦ãŠã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µã‚¤ã‚¯ãƒ«ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚
- åŸç†çš„ã«ã¯ã‚«ã‚¹ã‚¿ãƒ  ãƒªã‚½ãƒ¼ã‚¹ã‚’ç”¨ã„ã‚Œã°ã€Database ã‚’å«ã‚ Amplify ã§æ§‹æˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã—ãŸã€‚ç§ãŒã‚µãƒãƒ¼ãƒˆã«ç¢ºèªã—ãŸæ™‚ç‚¹ã§ã¯ã€ã‚µãƒãƒ¼ãƒˆã®è¦‹è§£ã‚‚åŒæ§˜ã§ã—ãŸã€‚ã—ã‹ã—ã€æœ€çµ‚çš„ã«ã‚«ã‚¹ã‚¿ãƒ  ãƒªã‚½ãƒ¼ã‚¹ã®å…¨é¢çš„ãªæ¡ç”¨ã¯æ–­å¿µã—ã¾ã—ãŸã€‚

https://docs.amplify.aws/react/build-a-backend/add-aws-services/custom-resources/

- Amplify ã§ç¨¼åƒã—ã¦ã„ã‚‹ Lambda (Render) ã‹ã‚‰ Backend API ã® Endpoint ã§ã‚ã‚‹ ALB ã¸ã®é€šä¿¡ã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å†…ãŠã‚ˆã³ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«ãªã‚Šã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/how-it-works.html#what-is-aws-global-network

---

è¨˜äº‹ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ã„ãŸã ã„æ–¹ã¯ã„ã„ã­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ğŸ‘‹


[^1]: https://github.com/aws-amplify/amplify-hosting/issues/3515

[^2]: https://nx.dev/

[^3]: https://turbo.build/repo/docs

[^4]: https://developer.hashicorp.com/terraform/cdktf
