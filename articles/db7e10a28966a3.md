---
title: "Local Development with Amplify Gen 2"
emoji: "ğŸ’¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["amplify", "nestjs", "prisma", "aurora"]
published: false
---

Sandbox ã¨è¨€ã‚ã‚Œã‚‹ Amplify Gen 2 (Amplify) ã§ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«ã¤ã„ã¦ã€‚

Amplify ã®å®Ÿç”¨æ€§ã«ã¤ã„ã¦èª¿ã¹ã‚‹ã€‚

Code ã¯ã“ã‚Œã€‚

https://github.com/danny-yamamoto/buttermilk-backend-app.git

## tl;dr
- Sandbox ã¯æœ¬ç•ªã¨åŒç­‰ã§æ§‹æˆã•ã‚Œã€åœæ­¢ã™ã‚‹ã¨è‡ªå‹•ã§ Resources ã¯å‰Šé™¤ã•ã‚Œã‚‹ã€‚
- Amplify ã§ Frontend ã‹ã‚‰ Backendã€Database ã¾ã§å…¨ã¦å®šç¾©ã§ãã‚‹ã€‚ç†è«–ä¸Šã€‚

## Implement the API
- NestJS ã§ API ã‚’å®Ÿè£…ã™ã‚‹ã€‚CRUD Method ã¾ã§ generate ã•ã‚Œã‚‹ã€‚ `nest g resource todo`
- CRUD Method ã« Prisma ã§å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹ã€‚

## Set up local AWS profile [^1]
- AWS CLI ã¯ VS Code ã® extension ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

https://github.com/danny-yamamoto/buttermilk-backend-app/blob/f8d8625a75740e0ebb81b8a2cc40224d7c04579b/.devcontainer/devcontainer.json#L9

- Sandbox ã‚’ deploy ã™ã‚‹ãŸã‚ã€Profile ã‚’æº–å‚™ã™ã‚‹ã€‚Profile ã® ID ã‚’ç¢ºèªã™ã‚‹ã€‚
```bash
aws configure sso
# Set AWS environment variables
vi ~/.aws/credentials
cat ~/.aws/credentials
```

## Bootstrap your AWS account [^2]
- Sandbox ã‚’èµ·å‹•ã™ã‚‹ã€‚
```bash
cat ~/.aws/config # Get profile
npx ampx sandbox --profile <profile-name>
```

```bash: log
node âœ /workspaces/buttermilk-backend-app (main) $ npx ampx sandbox --profile hoge-99999
  
  Amplify Sandbox
  
  Identifier:   node
  Stack:        amplify-buttermilkbackendapp-node-sandbox-99999

...

âœ¨  Total time: 572.82s


NOTICES         (What's this? https://github.com/aws/aws-cdk/wiki/CLI-Notices)

30241   (cli): Upgrading to v2.142.0 errors out on cdk diff with `Cannot read properties of undefined`

        Overview: A change was made to diff in CDK v2.142.0 to include changes
                  to properties that are only present in the change set. This
                  introduced cases where the resource type could be undefined
                  which resulted in an error from calling 'includes' on
                  undefined.

        Affected versions: cli: 2.142.0

        More information at: https://github.com/aws/aws-cdk/issues/30241


If you donâ€™t want to see a notice anymore, use "cdk acknowledge <id>". For example, "cdk acknowledge 30241".
[Sandbox] Watching for file changes...
File written: amplify_outputs.json
```

- ä»Šå›æ§‹æˆã•ã‚Œã‚‹ã®ã¯ VPC + Amazon Aurora
- Frontend ã‹ã‚‰ Backendã€Database ã¾ã§å…¨ã¦å®šç¾©ã§ãã‚‹ã€‚ç†è«–ä¸Šã€‚

https://github.com/danny-yamamoto/buttermilk-backend-app/blob/main/amplify/backend.ts

## Clean up
- ctl + c ã§åœæ­¢ã¨å‰Šé™¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚å®Œäº†å¾Œã€Resources ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã€‚

```bash
? Would you like to delete all the resources in your sandbox environment (This cannot be undone)? y
[Sandbox] Deleting all the resources in the sandbox environment...
amplify-buttermilkbackendapp-node-sandbox-99999: destroying... [1/1]

...

 âœ…  amplify-buttermilkbackendapp-node-sandbox-99999: destroyed

NOTICES         (What's this? https://github.com/aws/aws-cdk/wiki/CLI-Notices)

30241   (cli): Upgrading to v2.142.0 errors out on cdk diff with `Cannot read properties of undefined`

        Overview: A change was made to diff in CDK v2.142.0 to include changes
                  to properties that are only present in the change set. This
                  introduced cases where the resource type could be undefined
                  which resulted in an error from calling 'includes' on
                  undefined.

        Affected versions: cli: 2.142.0

        More information at: https://github.com/aws/aws-cdk/issues/30241


If you donâ€™t want to see a notice anymore, use "cdk acknowledge <id>". For example, "cdk acknowledge 30241".
[Sandbox] Finished deleting.

```

## Tips
- Database ã¨ã®æ¥ç¶šã‚’è¡Œã†å ´åˆã€Amplify ã® Custom Resources [^3] ã‚’å‚è€ƒã«å®Ÿè£…ãŒå¿…è¦ã€‚ãªãœãªã‚‰ã€æ—¢å­˜ã® Database ã¨æ¥ç¶šã™ã‚‹å ´åˆã€èªè¨¼ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

## Conclusion
è»¢è·ã—ã¦ 2 ãƒ¶æœˆãŒçµŒéã—ãŸ

ã‚ã‚Œã“ã‚Œæ‰‹ã‚’ã¤ã‘ã¦ã€ä½•ã‚‚å‡ºæ¥ã¦ã„ãªã„w

ä»Šåº¦ã€æ©Ÿä¼šãŒã‚ã‚Œã°ã€1 å¹´ãã‚‰ã„ã§å»ã£ã¦ã„ãå¤–å›½å‡ºèº«ã® Engineer ã®ä»•äº‹ã«å¯¾ã™ã‚‹ Stance ã‚’èã„ã¦ã¿ãŸã„

ç§ã¯æ¬²å¼µã‚Šã™ããªã®ã‹ã€‚ä½•ã‹ã«é›†ä¸­ã™ã‚‹ã¹ããªã®ã‹


[^1]: https://docs.amplify.aws/react/start/account-setup/#4-set-up-local-aws-profile
[^2]: https://docs.amplify.aws/react/start/account-setup/#5-bootstrap-your-aws-account
[^3]: https://docs.amplify.aws/react/build-a-backend/add-aws-services/custom-resources/
