---
title: "(WIP)ADOT ã‚’ä½¿ç”¨ã—ã¦ Next.js ã‚’è¨ˆæ¸¬ã™ã‚‹"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["otel", "nextjs", "aws", "adot", "trace"]
published: false
---

kubell Advent Calendar 2024 ã®æŠ•ç¨¿ã§ã™ã€‚

:::message
2024å¹´7æœˆ1æ—¥ã€Chatworkæ ªå¼ä¼šç¤¾ã¯æ ªå¼ä¼šç¤¾kubellã¸ã¨ç¤¾åå¤‰æ›´ã—ã¾ã—ãŸã€‚
:::

https://qiita.com/advent-calendar/2024/kubell

ã“ã®æŠ•ç¨¿ã§ã¯ã€AWS Distro for OpenTelemetry (ADOT) ã‚’ç”¨ã„ãŸ Next.js ã®è¨ˆæ¸¬ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## TL;DR

- Amplify Gen 2 (Amplify) ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã‚‹ Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« AWS Distro for OpenTelemetry (ADOT) ã‚’å°å…¥
- Amazon ECS (ECS) ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ ADOT Collector ã§ X-Ray ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚’å®Ÿç¾
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®è¨ˆæ¸¬ã§ã¯ Collector ã‚’ Sidecar ã¨ã—ã¦èµ·å‹•å¯èƒ½
- âš ï¸ Amplify Managed ã®åˆ¶ç´„ã«ã‚ˆã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® Tracing ã¨ãƒ­ã‚°ã®ç´ä»˜ã‘ã«ã¯åˆ¶é™ã‚ã‚Š

## ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ã€Amplify ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã€AWS Distro for OpenTelemetryï¼ˆADOTï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ADOT ã¯ã€AWS ãŒæä¾›ã™ã‚‹ OpenTelemetry ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ECS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

## å‰ææ¡ä»¶ã¨åˆ¶ç´„äº‹é …

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ Amplify Managed ã§é‹ç”¨ã•ã‚Œã¦ã„ã¾ã™
  - Amplify ã® CDN ã¨ Render ã¯ç®¡ç†ã•ã‚ŒãŸçŠ¶æ…‹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™
  - Render ã®è¨­å®šã¯ 2024å¹´12æœˆ1æ—¥æ™‚ç‚¹ã§ã¯å¤‰æ›´ã§ãã¾ã›ã‚“
  - ã“ã®åˆ¶ç´„ã«ã‚ˆã‚Šã€Tracing ã¨ãƒ­ã‚°ã‚’ç´ã¥ã‘ã¦è¦³å¯Ÿã™ã‚‹ã“ã¨ãŒå›°é›£ã§ã™

ã“ã‚Œã‚‰ã®åˆ¶ç´„ã¯ã€ç‰¹ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚„ãƒ‡ãƒãƒƒã‚°ã®éš›ã«è€ƒæ…®ãŒå¿…è¦ã§ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: Next.js (Amplify) ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰
- Server-side Rendering: Lambda
- ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°: ADOT
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ: ECS

## ADOT Collector ã®è¨­å®š

### ECS ã§ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š

ECS ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãª `config.yaml` ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

```yaml
extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:

exporters:
  debug:
    verbosity: detailed
  awsxray:
    region: 'ap-northeast-1'
  awsemf:
    region: 'ap-northeast-1'

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [awsxray]
    metrics:
      receivers: [otlp]
      exporters: [awsemf]
  extensions: [pprof, health_check]
  telemetry:
    logs:
      level: debug
```

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®è¨­å®š

ãƒ­ãƒ¼ã‚«ãƒ«ã§ ADOT ã‚’èµ·å‹•ã™ã‚‹å ´åˆã€AWS ã®èªè¨¼æƒ…å ±ãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã® Docker ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ï¼š

```bash
docker run --rm -p 13133:13133 -p 4317:4317 -p 4318:4318 -p 55680:55680 -p 8889:8888 \
  -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" \
  -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" \
  -e "AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}" \
  -e AWS_REGION=ap-northeast-1 \
  --name awscollector public.ecr.aws/aws-observability/aws-otel-collector:latest
```

### å¿…è¦ãª IAM ãƒãƒªã‚·ãƒ¼

ä»¥ä¸‹ã® IAM ãƒãƒªã‚·ãƒ¼ã¯ã€ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«å¿…è¦ã§ã™ã€‚ã“ã®ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€ADOT Collector ãŒ X-Ray ã‚„ CloudWatch ã¨é€£æºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:PutLogEvents",
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:DescribeLogGroups",
                "ssm:GetParameters",
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:GetSamplingStatisticSummaries"
            ],
            "Resource": "*"
        }
    ]
}
```

- ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã§ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã“ã¨ã§ã€ADOT Collector ã¯å¿…è¦ãªæ¨©é™ã‚’æŒã£ã¦ AWS ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å®Ÿè£…

### åŸºæœ¬å®Ÿè£…

[Next.js ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nextjs.org/docs/pages/building-your-application/optimizing/open-telemetry#manual-opentelemetry-configuration)ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§å®Ÿè£…ã§ãã¾ã™ã€‚ã“ã‚Œã¯`instrumentation.ts`ï¼ˆã¾ãŸã¯`instrumentation.js`ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿè£…ã—ã¾ã™ï¼š

```typescript
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { NodeSDK } from '@opentelemetry/sdk-node'
import { SimpleSpanProcessor } from '@opentelemetry/sdk-trace-node'
import { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions'

const sdk = new NodeSDK({
  resource: new Resource({
    [ATTR_SERVICE_NAME]: 'next-app',
  }),
  spanProcessor: new SimpleSpanProcessor(new OTLPTraceExporter()),
})
sdk.start()
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã“ã¨ã‚’è¡Œã„ã¾ã™ï¼š
- OTLP TraceExporter ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ HTTP ã§é€ä¿¡
- ãƒªã‚½ãƒ¼ã‚¹åï¼ˆã‚µãƒ¼ãƒ“ã‚¹åï¼‰ã‚’ `next-app` ã¨ã—ã¦è¨­å®š
- SimpleSpanProcessor ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã®å‡¦ç†ã‚’è¡Œã†

ã¾ãŸã€`next.config.js`ã«ä»¥ä¸‹ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼š

```javascript
module.exports = {
  experimental: {
    instrumentationHook: true
  }
}
```

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®ãƒã‚¤ãƒ³ãƒˆ

- Vercelä»¥å¤–ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹å ´åˆã¯ã€ç’°å¢ƒã«å¿œã˜ãŸã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¿…è¦ã§ã™
- Full Stack TypeScript ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®å®Ÿè£…ã‹ã‚‰ãƒ†ã‚¹ãƒˆã¾ã§ã‚’ä¸€è²«ã—ã¦è¡Œã†ã“ã¨ãŒå®¹æ˜“ã§ã™

## ECSã§ã®é‹ç”¨ã«ã¤ã„ã¦

- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆã€OpenTelemetry Collector ã‚’ Sidecar ã¨ã—ã¦èµ·å‹•ã§ãã¾ã™
- ECS ã§ã¯ã€ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã¯ 1 ã¤ã§ååˆ†ã§ã™ï¼ˆ `localhost` ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¯èƒ½ãªãŸã‚ï¼‰

## ã¾ã¨ã‚

- ADOT ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åŠ¹æœçš„ãªãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚
- ç‰¹ã« AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒã§ã¯ã€X-Ray ã¨ã®é€£æºã‚‚å®¹æ˜“ã§ã€é‹ç”¨é¢ã§ã‚‚å„ªã‚Œã¦ã„ã¾ã™ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- [Next.js OpenTelemetry Documentation](https://nextjs.org/docs/pages/building-your-application/optimizing/open-telemetry)
- [AWS Distro for OpenTelemetry ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://aws-otel.github.io/)
- [AWS X-Ray Documentation](https://docs.aws.amazon.com/xray/latest/devguide/aws-xray.html)
