---
title: "(WIP)ADOT ã‚’ä½¿ç”¨ã—ã¦ Next.js ã‚’è¨ˆæ¸¬ã™ã‚‹"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["otel", "nextjs", "aws", "adot", "trace"]
published: false
---

kubell Advent Calendar 2024 ã®æŠ•ç¨¿ã§ã™ã€‚

:::message
2024å¹´7æœˆ1æ—¥ã€Chatworkæ ªå¼ä¼šç¤¾ã¯æ ªå¼ä¼šç¤¾kubellã¸ã¨ç¤¾åå¤‰æ›´ã—ã¾ã—ãŸã€‚
:::

https://qiita.com/advent-calendar/2024/kubell

ã“ã®æŠ•ç¨¿ã§ã¯ã€AWS Distro for OpenTelemetry (ADOT) ã‚’ç”¨ã„ãŸ Next.js ã®è¨ˆæ¸¬ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## tl;dr

Render ã® Tracing ã« ADOT ã‚’ä½¿ç”¨ã™ã‚‹ã€Render ã¯ Amplify ã§ Hosting ã—ã¦ã„ã‚‹ Next.js ã® Lambda
ADOT ã¯ AWS ãŒé…å¸ƒã—ã¦ã„ã‚‹ Otel collector
ADOT ã¯ ECS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ
ECS ã§ Health Check ã‚’è¡Œã†ãŸã‚ã« config.yaml ã®ä¿®æ­£ãŒå¿…è¦ã ã£ãŸ
```yaml
extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:

exporters:
  debug:
    verbosity: detailed
  awsxray:
    region: 'ap-northeast-1'
  awsemf:
    region: 'ap-northeast-1'

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [awsxray]
    metrics:
      receivers: [otlp]
      exporters: [awsemf]

  extensions: [pprof, health_check]
  telemetry:
    logs:
      level: debug
```
ãƒ­ãƒ¼ã‚«ãƒ«ã§ ADOT ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ã¯ AWS ã® credentials ãŒå¿…è¦ã ã£ãŸ
```bash
docker run --rm -p 13133:13133 -p 4317:4317 -p 4318:4318 -p 55680:55680 -p 8889:8888 \
  -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" \
  -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" \
  -e "AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}" \
  -e AWS_REGION=ap-northeast-1 \
  --name awscollector public.ecr.aws/aws-observability/aws-otel-collector:latest
```
Tracing ã¨é€£æºã™ã‚‹ãŸã‚ã«å¿…è¦ãªæ¨©é™ã¯ä»¥ä¸‹ã®é€šã‚Šã ã£ãŸ
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:PutLogEvents",
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:DescribeLogGroups",
                "ssm:GetParameters",
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:GetSamplingStatisticSummaries"
            ],
            "Resource": "*"
        }
    ]
}
```
Render ã®å®Ÿè£…ã¯ Vercel ã® Docs ã®é€šã‚Šã ã£ãŸ
```typescript
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { NodeSDK } from '@opentelemetry/sdk-node'
import { SimpleSpanProcessor } from '@opentelemetry/sdk-trace-node'
import { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
const sdk = new NodeSDK({
  resource: new Resource({
    [ATTR_SERVICE_NAME]: 'next-app',
  }),
  spanProcessor: new SimpleSpanProcessor(new OTLPTraceExporter()),
})
sdk.start()
```
ãŸã ã—ã€Vercel ã« Hosting ã—ãªã„å ´åˆã¯ Custom ãŒå¿…è¦ã ã£ãŸ
ç§ãŸã¡ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ Full Stack TypeScript ã®ãŸã‚ã€Render ã®ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã‹ã‚‰ãƒ†ã‚¹ãƒˆã¾ã§ã‚’ä¸€è²«ã—ã¦è¡Œã†ã“ã¨ãŒæ¯”è¼ƒçš„å®¹æ˜“ã ã£ãŸ
Otel collector ã¯ Backend ã®å ´åˆã¯ Sidecar ã¨ã—ã¦èµ·å‹•ã§ãã‚‹ã€‚ECS ã®å ´åˆã€Port Mapping ã¯1ã¤ã§è‰¯ã„ã€‚ãªãœãªã‚‰ã€`localhost` ã§ Health Check ã§ãã‚‹ãŸã‚ã€‚
