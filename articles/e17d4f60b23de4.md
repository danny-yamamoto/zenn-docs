---
title: "(WIP)ADOT を使用して Next.js を計測する"
emoji: "📐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["otel", "nextjs", "aws", "adot", "trace"]
published: false
---

kubell Advent Calendar 2024 の投稿です。

:::message
2024年7月1日、Chatwork株式会社は株式会社kubellへと社名変更しました。
:::

https://qiita.com/advent-calendar/2024/kubell

この投稿では、AWS Distro for OpenTelemetry (ADOT) を用いた Next.js の計測について書きます。

## tl;dr

Render の Tracing に ADOT を使用する、Render は Amplify で Hosting している Next.js の Lambda
ADOT は AWS が配布している Otel collector
ADOT は ECS にデプロイした
ECS で Health Check を行うために config.yaml の修正が必要だった
```yaml
extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:

exporters:
  debug:
    verbosity: detailed
  awsxray:
    region: 'ap-northeast-1'
  awsemf:
    region: 'ap-northeast-1'

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [awsxray]
    metrics:
      receivers: [otlp]
      exporters: [awsemf]

  extensions: [pprof, health_check]
  telemetry:
    logs:
      level: debug
```
ローカルで ADOT を起動するためには AWS の credentials が必要だった
```bash
docker run --rm -p 13133:13133 -p 4317:4317 -p 4318:4318 -p 55680:55680 -p 8889:8888 \
  -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" \
  -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" \
  -e "AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}" \
  -e AWS_REGION=ap-northeast-1 \
  --name awscollector public.ecr.aws/aws-observability/aws-otel-collector:latest
```
Tracing と連携するために必要な権限は以下の通りだった
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:PutLogEvents",
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:DescribeLogGroups",
                "ssm:GetParameters",
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:GetSamplingStatisticSummaries"
            ],
            "Resource": "*"
        }
    ]
}
```
Render の実装は Vercel の Docs の通りだった
```typescript
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { NodeSDK } from '@opentelemetry/sdk-node'
import { SimpleSpanProcessor } from '@opentelemetry/sdk-trace-node'
import { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
const sdk = new NodeSDK({
  resource: new Resource({
    [ATTR_SERVICE_NAME]: 'next-app',
  }),
  spanProcessor: new SimpleSpanProcessor(new OTLPTraceExporter()),
})
sdk.start()
```
ただし、Vercel に Hosting しない場合は Custom が必要だった
私たちのプロダクトは Full Stack TypeScript のため、Render のコードの修正からテストまでを一貫して行うことが比較的容易だった
Otel collector は Backend の場合は Sidecar として起動できる。ECS の場合、Port Mapping は1つで良い。なぜなら、`localhost` で Health Check できるため。
